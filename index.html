<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#0d0a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>×©×—×§×™ ××•×¨ â€” ×ª×—×–×™×ª ×©×§×™×¢×•×ª ×•×–×¨×™×—×•×ª</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Heebo:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0814;
    --surface: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.08);
    --text: #f0e8d8;
    --muted: rgba(240,232,216,0.5);
    --gold: #e8b86d;
    --rose: #d4607a;
    --sky: #6ab0d4;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    overflow-x: hidden;
  }

  /* Background gradient sky */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 120% 60% at 50% 0%, rgba(212,96,122,0.15) 0%, transparent 60%),
      radial-gradient(ellipse 80% 40% at 80% 100%, rgba(232,184,109,0.1) 0%, transparent 50%),
      radial-gradient(ellipse 60% 30% at 20% 80%, rgba(106,176,212,0.08) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* Stars */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(1px 1px at 15% 10%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 35% 5%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 55% 15%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 72% 8%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 88% 12%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 5% 25%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 93% 30%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 45% 3%, rgba(255,255,255,0.8) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 480px;
    margin: 0 auto;
    padding: 24px 16px 40px;
  }

  header {
    text-align: center;
    padding: 32px 0 24px;
  }

  .logo-icon {
    font-size: 48px;
    display: block;
    margin-bottom: 8px;
    filter: drop-shadow(0 0 20px rgba(232,184,109,0.5));
    animation: float 4s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 700;
    letter-spacing: 0.02em;
    color: var(--text);
    margin-bottom: 4px;
  }

  .tagline {
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* Location bar */
  .location-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
    margin: 20px 0;
    cursor: pointer;
    transition: background 0.2s;
  }

  .location-bar:hover { background: rgba(255,255,255,0.07); }

  .location-icon { font-size: 18px; }

  .location-text {
    flex: 1;
    font-size: 14px;
    color: var(--muted);
  }

  .location-text strong {
    display: block;
    color: var(--text);
    font-size: 15px;
    font-weight: 600;
  }

  .refresh-btn {
    background: rgba(232,184,109,0.15);
    border: 1px solid rgba(232,184,109,0.3);
    border-radius: 8px;
    color: var(--gold);
    font-size: 12px;
    padding: 6px 12px;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    transition: all 0.2s;
  }

  .refresh-btn:hover { background: rgba(232,184,109,0.25); }
  .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Day cards */
  .day-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
    backdrop-filter: blur(10px);
    animation: slideUp 0.4s ease both;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .day-card:nth-child(2) { animation-delay: 0.1s; }
  .day-card:nth-child(3) { animation-delay: 0.2s; }

  .day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .day-name {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
  }

  .day-date {
    font-size: 12px;
    color: var(--muted);
  }

  .weather-summary {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--muted);
  }

  /* Sunrise / Sunset rows */
  .sun-events {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .sun-event {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
  }

  .sun-event-title {
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .sun-event-time {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--text);
  }

  /* Color score bar */
  .score-label {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
  }

  .score-value {
    font-weight: 600;
    font-size: 13px;
  }

  .score-bar-track {
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,0.07);
    overflow: hidden;
    margin-bottom: 8px;
  }

  .score-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease;
  }

  .score-description {
    font-size: 12px;
    font-weight: 600;
  }

  /* Color quality badges */
  .quality-spectacular { color: #ff7b54; }
  .quality-vivid { color: #ffb347; }
  .quality-nice { color: #ffd700; }
  .quality-mild { color: #87ceeb; }
  .quality-poor { color: var(--muted); }

  .bar-spectacular { background: linear-gradient(90deg, #ff7b54, #ff4e50); }
  .bar-vivid { background: linear-gradient(90deg, #ff9a44, #fc6076); }
  .bar-nice { background: linear-gradient(90deg, #ffd700, #f9a825); }
  .bar-mild { background: linear-gradient(90deg, #87ceeb, #5b9bd5); }
  .bar-poor { background: linear-gradient(90deg, #6b7280, #4b5563); }

  /* Color palette preview */
  .color-palette {
    display: flex;
    gap: 3px;
    margin-top: 8px;
    border-radius: 6px;
    overflow: hidden;
    height: 8px;
  }

  .palette-swatch {
    flex: 1;
    border-radius: 2px;
  }

  /* City search */
  .city-search-row {
    display: flex;
    gap: 8px;
    margin: -8px 0 20px;
  }

  .city-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    padding: 12px 16px;
    outline: none;
    transition: border-color 0.2s;
    direction: rtl;
  }

  .city-input::placeholder { color: var(--muted); }
  .city-input:focus { border-color: rgba(232,184,109,0.5); }

  .city-search-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-size: 18px;
    padding: 0 16px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .city-search-btn:hover { background: rgba(255,255,255,0.08); }

  /* Loading state */
  .loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .loading-spinner {
    font-size: 40px;
    display: block;
    margin-bottom: 16px;
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Error state */
  .error-box {
    background: rgba(212,96,122,0.1);
    border: 1px solid rgba(212,96,122,0.3);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    margin: 20px 0;
  }

  .error-box h3 {
    color: var(--rose);
    margin-bottom: 8px;
    font-size: 16px;
  }

  .error-box p {
    font-size: 13px;
    color: var(--muted);
    line-height: 1.6;
  }

  .btn-primary {
    display: block;
    width: 100%;
    margin-top: 16px;
    background: linear-gradient(135deg, var(--rose), var(--gold));
    border: none;
    border-radius: 12px;
    color: white;
    font-family: 'Heebo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    padding: 14px;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .btn-primary:hover { opacity: 0.85; }

  /* Share button */
  .share-section {
    margin-top: 24px;
    text-align: center;
  }

  .share-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    padding: 12px 24px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .share-btn:hover { background: rgba(255,255,255,0.1); }

  /* Footer */
  footer {
    text-align: center;
    margin-top: 32px;
    font-size: 11px;
    color: rgba(240,232,216,0.25);
    line-height: 1.8;
  }

  /* Install banner */
  .install-banner {
    display: none;
    align-items: center;
    gap: 12px;
    background: rgba(232,184,109,0.08);
    border: 1px solid rgba(232,184,109,0.2);
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 20px;
  }

  .install-banner.visible { display: flex; }
  .install-banner p { flex: 1; font-size: 13px; color: var(--muted); line-height: 1.5; }
  .install-banner strong { color: var(--gold); display: block; font-size: 14px; margin-bottom: 2px; }

  .install-dismiss {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
  }

</style>
</head>
<body>
<div class="container">
  <header>
    <span class="logo-icon">ğŸŒ…</span>
    <h1>×©×—×§×™ ××•×¨</h1>
    <p class="tagline">×ª×—×–×™×ª ×¦×‘×¢×•× ×™×•×ª ×©×§×™×¢×•×ª ×•×–×¨×™×—×•×ª</p>
  </header>

  <div class="install-banner" id="installBanner">
    <div>
      <strong>ğŸ“² ×”×ª×§×Ÿ ×›××¤×œ×™×§×¦×™×”</strong>
      <p>×œ×—×¥ ×¢×œ ×©×ª×£ â† "×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª" ×›×“×™ ×œ×”×ª×§×™×Ÿ</p>
    </div>
    <button class="install-dismiss" onclick="document.getElementById('installBanner').classList.remove('visible')">Ã—</button>
  </div>

  <div class="location-bar" onclick="loadData()">
    <span class="location-icon">ğŸ“</span>
    <div class="location-text">
      <strong id="locationName">×œ×—×¥ ×œ××™×ª×•×¨ ××™×§×•×</strong>
      <span id="locationCoords">GPS ××•×˜×•××˜×™</span>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="event.stopPropagation(); loadData()">GPS</button>
  </div>

  <div class="city-search-row">
    <input
      class="city-input"
      id="cityInput"
      type="text"
      placeholder="××• ×—×¤×© ×¢×™×¨... (×œ×“×•×’××”: ×ª×œ ××‘×™×‘)"
      onkeydown="if(event.key==='Enter') searchCity()"
    />
    <button class="city-search-btn" onclick="searchCity()">ğŸ”</button>
  </div>

  <div id="content">
    <div class="loading">
      <span class="loading-spinner">ğŸŒ</span>
      <p>×œ×—×¥ ×¢×œ "×¨×¢× ×Ÿ" ×›×“×™ ×œ××—×–×¨ ×ª×—×–×™×ª</p>
    </div>
  </div>

  <div class="share-section" id="shareSection" style="display:none">
    <button class="share-btn" onclick="shareApp()">
      <span>ğŸ“¤</span> ×©×ª×£ ×¢× ×—×‘×¨×™×
    </button>
  </div>

  <footer>
    × ×ª×•× ×™ ××–×’ ××•×•×™×¨: Open-Meteo â€¢ × ×ª×•× ×™ ×©××©: sunrise-sunset.org<br>
    ×ª×—×–×™×ª ×”×¦×‘×¢×•× ×™×•×ª ××—×•×©×‘×ª ×œ×¤×™ ×¢× ×Ÿ, ×œ×—×•×ª ×•××‘×§<br><br>
    ×©×—×§×™ ××•×¨ Â© 2025
  </footer>
</div>

<script>
const DAYS_HE = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
const MONTHS_HE = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

let userLat, userLon;

function init() {
  // Show install banner on mobile
  if (/Mobi|Android/i.test(navigator.userAgent) && !window.matchMedia('(display-mode: standalone)').matches) {
    document.getElementById('installBanner').classList.add('visible');
  }
  loadData();
}

async function loadData() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.textContent = '...';

  document.getElementById('content').innerHTML = `
    <div class="loading">
      <span class="loading-spinner">ğŸ›°ï¸</span>
      <p>×××ª×¨ ××™×§×•×...</p>
    </div>`;

  try {
    const pos = await getLocation();
    userLat = pos.coords.latitude;
    userLon = pos.coords.longitude;

    document.getElementById('content').innerHTML = `
      <div class="loading">
        <span class="loading-spinner">ğŸŒ¤ï¸</span>
        <p>××•×¨×™×“ × ×ª×•× ×™ ××–×’ ××•×•×™×¨...</p>
      </div>`;

    // Reverse geocode with nominatim
    const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userLat}&lon=${userLon}&format=json&accept-language=he`);
    const geoData = await geoRes.json();
    const city = geoData.address?.city || geoData.address?.town || geoData.address?.village || geoData.address?.county || '××™×§×•××š';
    document.getElementById('locationName').textContent = city;
    document.getElementById('locationCoords').textContent = `${userLat.toFixed(4)}Â°, ${userLon.toFixed(4)}Â°`;

    // Fetch weather + sun times
    const [weatherData, sunData] = await Promise.all([
      fetchWeather(userLat, userLon),
      fetchSunTimes(userLat, userLon)
    ]);

    renderCards(weatherData, sunData);
    document.getElementById('shareSection').style.display = 'block';

  } catch (e) {
    console.error(e);
    // GPS blocked (common when opening as local file) â€” prompt city search
    document.getElementById('locationName').textContent = 'GPS ×œ× ×–××™×Ÿ';
    document.getElementById('locationCoords').textContent = '×—×¤×© ×¢×™×¨ ×™×“× ×™×ª ×œ××˜×”';
    document.getElementById('content').innerHTML = `
      <div class="error-box" style="border-color:rgba(232,184,109,0.3);background:rgba(232,184,109,0.07)">
        <h3 style="color:var(--gold)">ğŸ“ ×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××™×§×•× ××•×˜×•××˜×™×ª</h3>
        <p>×›×¨×•× ×—×•×¡× GPS ×›×©×¤×•×ª×—×™× ×§×•×‘×¥ ××§×•××™.<br>
        ×¤×©×•×˜ ×”×§×œ×“ ××ª ×©× ×”×¢×™×¨ ×©×œ×š ×‘×ª×™×‘×ª ×”×—×™×¤×•×© ×œ××¢×œ×” ×•×œ×—×¥ ğŸ”</p>
      </div>`;
    // Focus the city input
    setTimeout(() => {
      const inp = document.getElementById('cityInput');
      if (inp) { inp.focus(); inp.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }, 300);
  }

  btn.disabled = false;
  btn.textContent = '×¨×¢× ×Ÿ';
}

function getLocation() {
  return new Promise((res, rej) => {
    if (!navigator.geolocation) rej(new Error('GPS ××™× ×• × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”'));
    navigator.geolocation.getCurrentPosition(res, (err) => {
      if (err.code === 1) rej(new Error('× × ×œ××¤×©×¨ ×’×™×©×” ×œ××™×§×•× ×‘×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ'));
      else rej(new Error('×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××™×§×•×'));
    }, { timeout: 10000 });
  });
}

async function fetchWeather(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=cloudcover,relativehumidity_2m,precipitation,windspeed_10m,weathercode&daily=weathercode,precipitation_sum&timezone=auto&forecast_days=3`;
  console.log('Fetching weather:', url);
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    console.log('Weather OK');
    return data;
  } catch (e) {
    console.warn('Weather API failed, using fallback data:', e.message);
    return null; // will use fallback in renderCards
  }
}

function getHourlyIndex(data, targetDateStr, targetHour) {
  // Find the index in hourly data closest to the given date+hour
  const times = data.hourly.time;
  const target = `${targetDateStr}T${String(targetHour).padStart(2,'0')}:00`;
  let idx = times.findIndex(t => t === target);
  if (idx === -1) idx = times.findIndex(t => t.startsWith(targetDateStr));
  return idx >= 0 ? idx : 0;
}

async function fetchSunTimes(lat, lon) {
  const results = [];
  const today = new Date();
  for (let i = 0; i < 3; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() + i);
    const dateStr = d.toISOString().split('T')[0];
    try {
      const res = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${dateStr}&formatted=0`);
      const data = await res.json();
      results.push(data.results);
    } catch {
      results.push(null);
    }
  }
  return results;
}

function calcColorScore(cloudCover, humidity, rain, windspeed) {
  // Sweet spot: 20-50% cloud, low rain, moderate humidity
  let score = 5;

  // Cloud cover - sweet spot around 20-50%
  if (cloudCover < 10) score -= 1; // Too clear, less drama
  else if (cloudCover <= 40) score += 3;
  else if (cloudCover <= 60) score += 1.5;
  else if (cloudCover <= 80) score -= 1;
  else score -= 3; // Overcast

  // Rain hurts
  if (rain > 5) score -= 2;
  else if (rain > 1) score -= 1;
  else if (rain === 0 && cloudCover > 20 && cloudCover < 60) score += 0.5;

  // Humidity - moderate is good (particles scatter light)
  if (humidity > 40 && humidity < 70) score += 0.5;
  else if (humidity > 80) score -= 0.5;

  // Wind - clears the air, can be good
  if (windspeed > 30) score += 0.5;

  return Math.min(10, Math.max(1, Math.round(score * 10) / 10));
}

function getQualityInfo(score) {
  if (score >= 8.5) return { label: 'ğŸ”¥ ××”××!', cls: 'spectacular', barCls: 'bar-spectacular' };
  if (score >= 7) return { label: 'ğŸŒŸ ×ª×•×¡×¡ ×•×¢×©×™×¨', cls: 'vivid', barCls: 'bar-vivid' };
  if (score >= 5.5) return { label: 'âœ¨ ×™×¤×”', cls: 'nice', barCls: 'bar-nice' };
  if (score >= 4) return { label: 'ğŸŒ¤ï¸ ×¢×“×™×Ÿ', cls: 'mild', barCls: 'bar-mild' };
  return { label: 'â˜ï¸ ×—×œ×©', cls: 'poor', barCls: 'bar-poor' };
}

function getPalette(score, isSunset) {
  if (score >= 8.5) return isSunset
    ? ['#ff2d00','#ff6b2b','#ff9a44','#ffc96e','#ffe8a8']
    : ['#ff4e6a','#ff8c69','#ffb347','#ffd700','#87ceeb'];
  if (score >= 7) return isSunset
    ? ['#e8390e','#f5712d','#f9a825','#fdd835','#fff3b0']
    : ['#c0392b','#e67e22','#f39c12','#f1c40f','#aed6f1'];
  if (score >= 5.5) return isSunset
    ? ['#c0392b','#e07030','#e8a040','#f5d080','#ffe0a0']
    : ['#8e44ad','#d35400','#e67e22','#f39c12','#d4e6f1'];
  if (score >= 4) return ['#5b7a9d','#7ea8c4','#a8c4d8','#c8dce8','#e0eaf2'];
  return ['#4a5568','#6b7280','#9ca3af','#d1d5db','#e5e7eb'];
}

function formatLocalTime(utcStr) {
  if (!utcStr) return '--:--';
  try {
    const d = new Date(utcStr);
    return d.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
  } catch { return '--:--'; }
}

function weatherCodeToEmoji(code) {
  if (code === 0) return 'â˜€ï¸';
  if (code <= 2) return 'â›…';
  if (code <= 3) return 'â˜ï¸';
  if (code <= 49) return 'ğŸŒ«ï¸';
  if (code <= 67) return 'ğŸŒ§ï¸';
  if (code <= 77) return 'â„ï¸';
  if (code <= 82) return 'ğŸŒ¦ï¸';
  return 'â›ˆï¸';
}

function weatherCodeToText(code) {
  if (code === 0) return '×©××™×™× ×‘×”×™×¨×™×';
  if (code <= 2) return '××¢×•× ×Ÿ ×—×œ×§×™×ª';
  if (code <= 3) return '××¢×•× ×Ÿ';
  if (code <= 49) return '×¢×¨×¤×œ';
  if (code <= 67) return '×’×©×';
  if (code <= 77) return '×©×œ×’';
  if (code <= 82) return '×××˜×¨×™×';
  return '×¡×•×¤×ª ×‘×¨×§×™×';
}

function renderCards(weatherData, sunData) {
  const today = new Date();
  let html = '<div id="dayCards">';

  for (let i = 0; i < 3; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() + i);
    const dayName = i === 0 ? '×”×™×•×' : i === 1 ? '××—×¨' : `×™×•× ${DAYS_HE[d.getDay()]}`;
    const dateStrDisplay = `${d.getDate()} ×‘${MONTHS_HE[d.getMonth()]}`;
    const dateStr = d.toISOString().split('T')[0];
    const wCode = weatherData?.daily?.weathercode?.[i] ?? 1;

    // Get sunrise/sunset hours for precise hourly lookup
    const sunriseUTC = sunData[i]?.sunrise;
    const sunsetUTC = sunData[i]?.sunset;
    const srHour = sunriseUTC ? new Date(sunriseUTC).getHours() : 6;
    const ssHour = sunsetUTC ? new Date(sunsetUTC).getHours() : 19;

    // Extract hourly data at the exact sunrise/sunset hour
    let srCloud, srHumidity, srRain, srWind;
    let ssCloud, ssHumidity, ssRain, ssWind;

    if (weatherData?.hourly) {
      const srIdx = getHourlyIndex(weatherData, dateStr, srHour);
      const ssIdx = getHourlyIndex(weatherData, dateStr, ssHour);
      srCloud    = weatherData.hourly.cloudcover[srIdx] ?? 40;
      srHumidity = weatherData.hourly.relativehumidity_2m[srIdx] ?? 55;
      srRain     = weatherData.hourly.precipitation[srIdx] ?? 0;
      srWind     = weatherData.hourly.windspeed_10m[srIdx] ?? 15;
      ssCloud    = weatherData.hourly.cloudcover[ssIdx] ?? 40;
      ssHumidity = weatherData.hourly.relativehumidity_2m[ssIdx] ?? 55;
      ssRain     = weatherData.hourly.precipitation[ssIdx] ?? 0;
      ssWind     = weatherData.hourly.windspeed_10m[ssIdx] ?? 15;
    } else {
      // Fallback values
      srCloud = ssCloud = 40; srHumidity = ssHumidity = 55;
      srRain = ssRain = 0; srWind = ssWind = 15;
    }

    const sunriseScore = calcColorScore(srCloud, srHumidity, srRain, srWind);
    const ssScoreClamped = calcColorScore(ssCloud, ssHumidity, ssRain, ssWind);
    const humidity = srHumidity; // for display

    const srQ = getQualityInfo(sunriseScore);
    const ssQ = getQualityInfo(ssScoreClamped);

    const sunrise = sunData[i] ? formatLocalTime(sunData[i].sunrise) : '--:--';
    const sunset = sunData[i] ? formatLocalTime(sunData[i].sunset) : '--:--';

    const srPalette = getPalette(sunriseScore, false);
    const ssPalette = getPalette(ssScoreClamped, true);

    const srPaletteHtml = srPalette.map(c => `<div class="palette-swatch" style="background:${c}"></div>`).join('');
    const ssPaletteHtml = ssPalette.map(c => `<div class="palette-swatch" style="background:${c}"></div>`).join('');

    html += `
      <div class="day-card" style="animation-delay:${i * 0.12}s">
        <div class="day-header">
          <div>
            <div class="day-name">${dayName}</div>
            <div class="day-date">${dateStrDisplay}</div>
          </div>
          <div class="weather-summary">
            <span>${weatherCodeToEmoji(wCode)}</span>
            <span>${weatherCodeToText(wCode)}</span>
            <span style="color:var(--sky)">ğŸ’§${humidity}%</span>
          </div>
        </div>
        <div class="sun-events">
          <div class="sun-event">
            <div class="sun-event-title">ğŸŒ„ ×–×¨×™×—×”</div>
            <div class="sun-event-time">${sunrise}</div>
            <div class="score-label">
              <span>×¦×‘×¢×•× ×™×•×ª</span>
              <span class="score-value quality-${srQ.cls}">${sunriseScore}/10</span>
            </div>
            <div class="score-bar-track">
              <div class="score-bar-fill ${srQ.barCls}" style="width:${sunriseScore * 10}%"></div>
            </div>
            <div class="score-description quality-${srQ.cls}">${srQ.label}</div>
            <div class="color-palette">${srPaletteHtml}</div>
          </div>
          <div class="sun-event">
            <div class="sun-event-title">ğŸŒ‡ ×©×§×™×¢×”</div>
            <div class="sun-event-time">${sunset}</div>
            <div class="score-label">
              <span>×¦×‘×¢×•× ×™×•×ª</span>
              <span class="score-value quality-${ssQ.cls}">${ssScoreClamped}/10</span>
            </div>
            <div class="score-bar-track">
              <div class="score-bar-fill ${ssQ.barCls}" style="width:${ssScoreClamped * 10}%"></div>
            </div>
            <div class="score-description quality-${ssQ.cls}">${ssQ.label}</div>
            <div class="color-palette">${ssPaletteHtml}</div>
          </div>
        </div>
      </div>`;
  }

  html += '</div>';
  document.getElementById('content').innerHTML = html;
}

async function searchCity() {
  const query = document.getElementById('cityInput').value.trim();
  if (!query) return;

  document.getElementById('content').innerHTML = `
    <div class="loading">
      <span class="loading-spinner">ğŸ”</span>
      <p>××—×¤×© ××ª "${query}"...</p>
    </div>`;
  document.getElementById('shareSection').style.display = 'none';

  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&accept-language=he`);
    const data = await res.json();
    if (!data.length) throw new Error(`×œ× × ××¦××” ×¢×™×¨ ×‘×©× "${query}"`);

    userLat = parseFloat(data[0].lat);
    userLon = parseFloat(data[0].lon);
    const cityName = data[0].display_name.split(',')[0];

    document.getElementById('locationName').textContent = cityName;
    document.getElementById('locationCoords').textContent = `${userLat.toFixed(4)}Â°, ${userLon.toFixed(4)}Â°`;

    document.getElementById('content').innerHTML = `
      <div class="loading">
        <span class="loading-spinner">ğŸŒ¤ï¸</span>
        <p>××•×¨×™×“ ×ª×—×–×™×ª ×¢×‘×•×¨ ${cityName}...</p>
      </div>`;

    const [weatherData, sunData] = await Promise.all([
      fetchWeather(userLat, userLon),
      fetchSunTimes(userLat, userLon)
    ]);
    renderCards(weatherData, sunData);
    document.getElementById('shareSection').style.display = 'block';
  } catch (e) {
    document.getElementById('content').innerHTML = `
      <div class="error-box">
        <h3>×©×’×™××”</h3>
        <p>${e.message}</p>
      </div>`;
  }
}

async function shareApp() {
  const APK_LINK = 'https://drive.google.com/file/d/1lGmM9w8B71dgePXFh79aXFIVaLEZL9X5/view?usp=sharing';
  const shareData = {
    title: '×©×—×§×™ ××•×¨ â€” ×ª×—×–×™×ª ×©×§×™×¢×•×ª ×•×–×¨×™×—×•×ª',
    text: 'ğŸŒ… ×’×œ×” ×›××” ×¦×‘×¢×•× ×™×•×ª ×™×”×™×• ×”×©×§×™×¢×•×ª ×•×”×–×¨×™×—×•×ª ×”×§×¨×•×‘×•×ª!\n×”×•×¨×“ ××ª ×”××¤×œ×™×§×¦×™×”:',
    url: APK_LINK
  };
  try {
    if (navigator.share) await navigator.share(shareData);
    else {
      await navigator.clipboard.writeText(APK_LINK);
      alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§! ×©×œ×— ×œ×—×‘×¨×™× ğŸŒ…');
    }
  } catch {}
}

init();
</script>
</body>
</html>
