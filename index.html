<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#07040f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>×“××“×•××™×</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Heebo:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #07040f;
  --surface: rgba(255,255,255,0.038);
  --border: rgba(255,185,80,0.12);
  --border-lit: rgba(255,185,80,0.28);
  --text: #f4e8d4;
  --muted: rgba(244,232,212,0.42);
  --gold: #f0b84a;
  --gold2: #ffd46a;
  --rose: #e04868;
  --sky: #5aaed4;
  --green: #4ec870;
  --amber: #ff9030;
  /* dynamic bg vars â€” updated by JS based on today's score */
  --dyn1: rgba(200,60,100,0.17);
  --dyn2: rgba(240,165,50,0.13);
  --dyn3: rgba(60,110,220,0.09);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family:'Heebo',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100dvh;
  overflow-x:hidden;
  transition: --dyn1 1s, --dyn2 1s;
}

/* â”€â”€ Splash screen â”€â”€ */
#splash {
  position:fixed; inset:0; z-index:9999;
  background:#07040f;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  transition:opacity 0.7s ease, transform 0.7s ease;
}
#splash.hidden { opacity:0; transform:scale(1.04); pointer-events:none; }
.splash-logo {
  width:110px; height:110px;
  filter:drop-shadow(0 0 30px rgba(240,165,50,0.8)) drop-shadow(0 0 60px rgba(200,60,100,0.5));
  animation:splash-float 2s ease-in-out infinite;
}
@keyframes splash-float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
.splash-title {
  font-family:'Cormorant Garamond',serif; font-size:48px; font-weight:600;
  background:linear-gradient(140deg,#ffd46a 0%,#f09030 42%,#e04868 100%);
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  margin-top:20px; letter-spacing:0.06em;
}
.splash-sub { font-size:12px; color:var(--muted); letter-spacing:0.18em; text-transform:uppercase; margin-top:8px; }
.splash-bar {
  width:120px; height:2px; background:rgba(255,255,255,0.08);
  border-radius:2px; margin-top:32px; overflow:hidden;
}
.splash-bar-fill {
  height:100%; width:0%; border-radius:2px;
  background:linear-gradient(90deg,var(--rose),var(--gold));
  animation:splash-load 1.6s ease forwards;
}
@keyframes splash-load { 0%{width:0%} 100%{width:100%} }

/* â”€â”€ Deep night sky background â”€â”€ */
body::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(ellipse 150% 55% at 50% -5%, var(--dyn1) 0%, transparent 55%),
    radial-gradient(ellipse 100% 50% at 90% 110%, var(--dyn2) 0%, transparent 50%),
    radial-gradient(ellipse  70% 35% at  8% 85%, var(--dyn3) 0%, transparent 50%),
    radial-gradient(ellipse  60% 40% at 55% 45%, rgba(100,40,160,0.05) 0%, transparent 60%);
  transition:background 2s ease;
}

/* â”€â”€ Stars â”€â”€ */
body::after {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background-image:
    radial-gradient(1.8px 1.8px at  7%  5%, rgba(255,255,255,0.95) 0%,transparent 100%),
    radial-gradient(1.2px 1.2px at 20%  3%, rgba(255,255,255,0.55) 0%,transparent 100%),
    radial-gradient(2.2px 2.2px at 37%  8%, rgba(255,230,170,0.80) 0%,transparent 100%),
    radial-gradient(1.0px 1.0px at 51%  2%, rgba(255,255,255,0.45) 0%,transparent 100%),
    radial-gradient(1.8px 1.8px at 66%  6%, rgba(255,255,255,0.75) 0%,transparent 100%),
    radial-gradient(1.2px 1.2px at 80%  1%, rgba(190,220,255,0.65) 0%,transparent 100%),
    radial-gradient(2.4px 2.4px at 93% 10%, rgba(255,255,255,0.90) 0%,transparent 100%),
    radial-gradient(1.0px 1.0px at  2% 16%, rgba(255,255,255,0.40) 0%,transparent 100%),
    radial-gradient(1.5px 1.5px at 46%  0%, rgba(255,255,255,0.85) 0%,transparent 100%),
    radial-gradient(1.0px 1.0px at 14% 13%, rgba(255,255,255,0.35) 0%,transparent 100%),
    radial-gradient(1.3px 1.3px at 86% 15%, rgba(200,215,255,0.55) 0%,transparent 100%),
    radial-gradient(1.0px 1.0px at 73% 11%, rgba(255,245,200,0.50) 0%,transparent 100%);
}

/* â”€â”€ Layout â”€â”€ */
.container { position:relative; z-index:1; max-width:480px; margin:0 auto; padding:20px 16px 52px; }

/* â•â• HEADER â•â• */
header { text-align:center; padding:32px 0 22px; }
.logo-wrap { position:relative; display:inline-block; margin-bottom:14px; }
.logo-svg  {
  width:86px; height:86px; display:block;
  filter: drop-shadow(0 0 18px rgba(240,165,50,0.75)) drop-shadow(0 0 40px rgba(200,60,100,0.45));
  animation: float 5s ease-in-out infinite;
}
.logo-glow {
  position:absolute; inset:-24px; border-radius:50%;
  background:radial-gradient(circle, rgba(240,165,50,0.18) 0%, transparent 68%);
  animation:glow-pulse 3.5s ease-in-out infinite; pointer-events:none;
}
@keyframes float      { 0%,100%{transform:translateY(0) rotate(-1deg)} 50%{transform:translateY(-9px) rotate(1deg)} }
@keyframes glow-pulse { 0%,100%{opacity:0.5;transform:scale(1)} 50%{opacity:1;transform:scale(1.12)} }
h1 {
  font-family:'Cormorant Garamond',serif; font-size:38px; font-weight:600; letter-spacing:0.05em;
  background:linear-gradient(140deg,#ffd46a 0%,#f09030 42%,#e04868 100%);
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:6px;
}
.tagline { font-size:10.5px; color:var(--muted); letter-spacing:0.20em; text-transform:uppercase; font-weight:300; }
.header-line { width:56px; height:1px; margin:14px auto 0; background:linear-gradient(90deg,transparent,var(--gold),transparent); }

/* â”€â”€ Streak badge â”€â”€ */
.streak-badge {
  display:inline-flex; align-items:center; gap:5px;
  background:linear-gradient(135deg,rgba(255,165,0,0.15),rgba(255,80,50,0.1));
  border:1px solid rgba(255,165,0,0.3); border-radius:20px;
  padding:4px 12px; font-size:12px; font-weight:600; color:var(--gold2);
  margin-top:10px; cursor:default;
  animation:slideUp 0.5s ease both;
}

/* â•â• TABS â•â• */
.tabs {
  display:flex; gap:4px; margin:16px 0 14px;
  background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:16px; padding:4px;
  backdrop-filter:blur(16px);
}
.tab {
  flex:1; text-align:center; padding:9px 4px; border-radius:11px;
  font-size:13px; font-weight:500; cursor:pointer;
  transition:all 0.25s cubic-bezier(.4,0,.2,1);
  color:var(--muted); border:none; background:none; font-family:'Heebo',sans-serif;
}
.tab.active {
  background:linear-gradient(135deg,rgba(240,180,60,0.22),rgba(200,60,100,0.14));
  color:var(--gold2);
  box-shadow:inset 0 0 0 1px rgba(240,180,60,0.22), 0 2px 10px rgba(240,165,50,0.12);
}

/* â•â• LOCATION â•â• */
.location-bar {
  display:flex; align-items:center; gap:10px;
  background:linear-gradient(135deg,rgba(255,185,80,0.055),rgba(200,60,100,0.028));
  border:1px solid var(--border); border-radius:14px;
  padding:13px 16px; margin-bottom:10px; cursor:pointer;
  transition:all 0.25s; backdrop-filter:blur(16px);
}
.location-bar:hover { border-color:var(--border-lit); background:rgba(255,255,255,0.055); }
.location-icon { font-size:20px; }
.location-text { flex:1; }
.location-text strong { display:block; color:var(--text); font-size:15px; font-weight:600; margin-bottom:1px; }
.location-text span   { font-size:12px; color:var(--muted); }
.refresh-btn {
  background:linear-gradient(135deg,rgba(240,180,60,0.22),rgba(240,165,50,0.12));
  border:1px solid rgba(240,180,60,0.32); border-radius:8px;
  color:var(--gold2); font-size:11px; font-weight:600; letter-spacing:0.06em;
  padding:6px 14px; cursor:pointer; font-family:'Heebo',sans-serif; transition:all 0.2s;
}
.refresh-btn:hover { background:rgba(240,180,60,0.32); box-shadow:0 0 14px rgba(240,165,50,0.22); }
.refresh-btn:disabled { opacity:0.38; cursor:not-allowed; }

/* â•â• CITY SEARCH + FAVORITES â•â• */
.city-search-row { display:flex; gap:8px; margin-bottom:6px; }
.city-input {
  flex:1; background:rgba(255,255,255,0.028); border:1px solid var(--border);
  border-radius:12px; color:var(--text); font-family:'Heebo',sans-serif;
  font-size:14px; padding:12px 16px; outline:none; transition:all 0.25s; direction:rtl;
}
.city-input::placeholder { color:var(--muted); }
.city-input:focus { border-color:rgba(240,180,60,0.44); background:rgba(240,180,60,0.04); box-shadow:0 0 0 3px rgba(240,165,50,0.09); }
.city-search-btn {
  background:rgba(255,255,255,0.035); border:1px solid var(--border);
  border-radius:12px; color:var(--muted); font-size:18px;
  padding:0 14px; cursor:pointer; transition:all 0.2s;
}
.city-search-btn:hover { background:rgba(255,255,255,0.08); color:var(--text); border-color:var(--border-lit); }

/* Favorites strip */
.favorites-strip {
  display:flex; gap:6px; overflow-x:auto; padding:4px 0 10px;
  scrollbar-width:none;
}
.favorites-strip::-webkit-scrollbar { display:none; }
.fav-chip {
  flex-shrink:0; display:flex; align-items:center; gap:5px;
  background:rgba(240,180,60,0.08); border:1px solid rgba(240,180,60,0.2);
  border-radius:20px; padding:5px 10px 5px 12px; cursor:pointer;
  font-size:12px; color:var(--gold); white-space:nowrap; transition:all 0.2s;
}
.fav-chip:hover { background:rgba(240,180,60,0.16); border-color:rgba(240,180,60,0.35); }
.fav-remove { color:var(--muted); font-size:14px; line-height:1; padding:0 2px; }
.fav-remove:hover { color:var(--rose); }
.fav-add-btn {
  flex-shrink:0; background:none; border:1px dashed rgba(240,180,60,0.25);
  border-radius:20px; padding:5px 12px; font-size:12px; color:var(--muted);
  cursor:pointer; font-family:'Heebo',sans-serif; transition:all 0.2s; white-space:nowrap;
}
.fav-add-btn:hover { border-color:var(--gold); color:var(--gold); }

/* â•â• NOTIFICATIONS â•â• */
.notif-banner {
  background:rgba(50,200,80,0.07); border:1px solid rgba(50,200,80,0.2);
  border-radius:15px; padding:14px 16px; margin-bottom:14px;
}
.notif-banner-title { color:var(--green); font-size:13.5px; font-weight:600; margin-bottom:10px; }
.notif-banner-row   { display:flex; align-items:center; gap:10px; margin-bottom:7px; }
.notif-banner-row:last-child { margin-bottom:0; }
.notif-banner-label { flex:1; font-size:13px; color:var(--muted); }
.notif-toggle {
  background:rgba(50,200,80,0.14); border:1px solid rgba(50,200,80,0.28);
  border-radius:8px; color:var(--green); font-size:12px; font-weight:600;
  padding:6px 14px; cursor:pointer; font-family:'Heebo',sans-serif;
  white-space:nowrap; min-width:68px; text-align:center; transition:all 0.2s;
}
.notif-toggle.off { background:rgba(255,255,255,0.04); border-color:var(--border); color:var(--muted); }

/* â”€â”€ Notif threshold row â”€â”€ */
.notif-threshold-row { display:flex; align-items:center; gap:8px; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.06); }
.notif-threshold-label { flex:1; font-size:12px; color:var(--muted); }
.threshold-btns { display:flex; gap:4px; }
.threshold-btn {
  background:rgba(255,255,255,0.05); border:1px solid var(--border);
  border-radius:6px; color:var(--muted); font-size:11px; font-weight:600;
  padding:4px 8px; cursor:pointer; font-family:'Heebo',sans-serif; transition:all 0.2s;
}
.threshold-btn.active { background:rgba(240,180,60,0.2); border-color:rgba(240,180,60,0.4); color:var(--gold2); }

/* â•â• DAY CARDS â•â• */
.day-card {
  background:linear-gradient(150deg,rgba(255,255,255,0.048) 0%,rgba(255,255,255,0.018) 100%);
  border:1px solid var(--border); border-radius:22px;
  padding:20px; margin-bottom:16px;
  backdrop-filter:blur(24px);
  animation:slideUp 0.55s cubic-bezier(.22,1,.36,1) both;
  box-shadow:0 6px 28px rgba(0,0,0,0.32), inset 0 1px 0 rgba(255,255,255,0.065);
}
@keyframes slideUp { from{opacity:0;transform:translateY(26px) scale(0.975)} to{opacity:1;transform:none} }

.day-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px; }
.day-name {
  font-family:'Cormorant Garamond',serif; font-size:24px; font-weight:600; letter-spacing:0.03em;
  background:linear-gradient(120deg,var(--text) 0%,var(--gold) 100%);
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
}
.day-date { font-size:11px; color:var(--muted); margin-top:3px; letter-spacing:0.05em; }
.weather-summary {
  display:flex; align-items:center; gap:5px; font-size:11.5px; color:var(--muted);
  background:rgba(255,255,255,0.045); border:1px solid var(--border); border-radius:8px; padding:5px 10px;
}

/* â•â• SUN EVENTS â•â• */
.sun-events { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px; }
.sun-event {
  background:linear-gradient(155deg,rgba(255,255,255,0.042) 0%,rgba(255,255,255,0.014) 100%);
  border:1px solid var(--border); border-radius:16px; padding:14px;
  position:relative; overflow:hidden; transition:border-color 0.3s;
}
.sun-event::after {
  content:''; position:absolute; top:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,185,80,0.3),transparent);
}
.sun-event-title { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.14em; margin-bottom:7px; font-weight:500; }
.sun-event-time  { font-size:22px; font-weight:600; margin-bottom:4px; font-family:'Cormorant Garamond',serif; letter-spacing:0.02em; }

/* Golden window */
.golden-window {
  font-size:10px; color:var(--gold); margin-bottom:8px;
  background:rgba(240,165,50,0.1); border-radius:5px; padding:2px 6px; display:inline-block;
}

.score-label     { font-size:10px; color:var(--muted); margin-bottom:5px; display:flex; justify-content:space-between; }
.score-value     { font-weight:700; font-size:12.5px; }
.score-bar-track { height:5px; border-radius:3px; background:rgba(255,255,255,0.06); overflow:hidden; margin-bottom:8px; }
.score-bar-fill  { height:100%; border-radius:3px; transition:width 1.3s cubic-bezier(.22,1,.36,1); }
.score-description { font-size:11px; font-weight:600; letter-spacing:0.02em; }

/* Big palette */
.color-palette {
  display:flex; gap:0; margin-top:12px; border-radius:10px; overflow:hidden;
  height:18px; box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
.palette-swatch { flex:1; }

.quality-spectacular { color:#ff7040 }
.quality-vivid       { color:#ffaa38 }
.quality-nice        { color:#f0cc40 }
.quality-mild        { color:#70b8e0 }
.quality-poor        { color:var(--muted) }

.bar-spectacular { background:linear-gradient(90deg,#cc2200,#ff5030,#ff9040) }
.bar-vivid       { background:linear-gradient(90deg,#e06010,#ff9030,#ffcc40) }
.bar-nice        { background:linear-gradient(90deg,#e0aa00,#f0cc40) }
.bar-mild        { background:linear-gradient(90deg,#3888b8,#70b8e0) }
.bar-poor        { background:linear-gradient(90deg,#303040,#505060) }

/* â•â• ACCORDION weather detail â•â• */
.accordion-btn {
  width:100%; background:rgba(255,255,255,0.025); border:1px solid var(--border);
  border-radius:12px; color:var(--muted); font-family:'Heebo',sans-serif;
  font-size:12px; padding:9px 14px; cursor:pointer;
  display:flex; align-items:center; justify-content:space-between;
  transition:all 0.2s; margin-top:2px;
}
.accordion-btn:hover { background:rgba(255,255,255,0.05); color:var(--text); border-color:var(--border-lit); }
.accordion-arrow { transition:transform 0.3s; font-size:10px; }
.accordion-arrow.open { transform:rotate(180deg); }
.weather-detail {
  background:rgba(255,255,255,0.02); border:1px solid var(--border);
  border-radius:16px; padding:14px; margin-top:6px;
  overflow:hidden; max-height:0; opacity:0;
  transition:max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
}
.weather-detail.open { max-height:600px; opacity:1; }
.weather-detail-title { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.13em; margin-bottom:12px; font-weight:500; }
.weather-grid { display:grid; grid-template-columns:1fr 1fr; gap:11px; }
.weather-item { display:flex; align-items:center; gap:9px; }
.weather-item-icon { font-size:22px; flex-shrink:0; }
.weather-item-text { font-size:11px; color:var(--muted); }
.weather-item-text strong { display:block; color:var(--text); font-size:14px; font-weight:600; }
.hourly-strip { display:flex; gap:6px; overflow-x:auto; padding-bottom:4px; margin-top:12px; scrollbar-width:none; }
.hourly-strip::-webkit-scrollbar { display:none; }
.hourly-item {
  flex-shrink:0; text-align:center;
  background:rgba(255,255,255,0.03); border:1px solid var(--border);
  border-radius:12px; padding:9px 10px; min-width:54px; transition:border-color 0.2s;
}
.hourly-item:hover { border-color:var(--border-lit); }
.hourly-time  { font-size:10px; color:var(--muted); margin-bottom:5px; }
.hourly-icon  { font-size:20px; margin-bottom:4px; line-height:1.1; }
.hourly-temp  { font-size:13px; font-weight:600; }
.hourly-cloud { font-size:10px; color:var(--muted); margin-top:2px; }

/* â•â• RATING â•â• */
.rating-row { display:flex; align-items:center; justify-content:space-between; margin-top:14px; padding-top:14px; border-top:1px solid var(--border); }
.rating-label { font-size:12px; color:var(--muted); }
.rating-stars { display:flex; gap:4px; }
.rating-star { font-size:22px; cursor:pointer; opacity:0.3; transition:all 0.15s; filter:grayscale(0.4); }
.rating-star.active { opacity:1; transform:scale(1.18); filter:none; }
.rating-saved { font-size:11px; color:var(--green); margin-top:4px; display:none; }

/* â•â• WEEKLY CHART â•â• */
.week-chart-section {
  background:linear-gradient(145deg,rgba(255,255,255,0.04),rgba(255,255,255,0.015));
  border:1px solid var(--border); border-radius:20px; padding:18px; margin-bottom:16px;
  animation:slideUp 0.5s ease both;
}
.week-chart-title {
  font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:600; margin-bottom:4px;
  background:linear-gradient(120deg,var(--text),var(--gold));
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
}
.week-chart-sub { font-size:11px; color:var(--muted); margin-bottom:16px; }
.chart-bars { display:flex; gap:6px; align-items:flex-end; height:80px; }
.chart-bar-wrap { flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; }
.chart-bar-outer { width:100%; background:rgba(255,255,255,0.06); border-radius:6px; overflow:hidden; flex:1; display:flex; align-items:flex-end; }
.chart-bar-inner { width:100%; border-radius:6px; transition:height 0.8s cubic-bezier(.22,1,.36,1); min-height:4px; }
.chart-bar-label { font-size:9px; color:var(--muted); white-space:nowrap; }
.chart-bar-score { font-size:10px; font-weight:700; }

/* â•â• JOURNAL â•â• */
.journal-empty { text-align:center; padding:52px 20px; color:var(--muted); }
.journal-empty .je-icon { font-size:52px; display:block; margin-bottom:14px; filter:drop-shadow(0 0 12px rgba(240,180,60,0.3)); }
.journal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
.journal-stats {
  display:flex; gap:10px; margin-bottom:16px;
}
.journal-stat {
  flex:1; background:rgba(255,255,255,0.03); border:1px solid var(--border);
  border-radius:14px; padding:12px; text-align:center;
}
.journal-stat-num { font-family:'Cormorant Garamond',serif; font-size:24px; font-weight:600; color:var(--gold); }
.journal-stat-label { font-size:10px; color:var(--muted); margin-top:2px; }
.journal-entry {
  background:linear-gradient(145deg,rgba(255,255,255,0.042),rgba(255,255,255,0.016));
  border:1px solid var(--border); border-radius:18px; padding:16px; margin-bottom:12px;
  animation:slideUp 0.35s cubic-bezier(.22,1,.36,1) both;
  box-shadow:0 4px 16px rgba(0,0,0,0.25);
}
.journal-entry-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.journal-entry-date { font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:600; }
.journal-entry-loc  { font-size:11.5px; color:var(--muted); margin-top:2px; }
.journal-scores { display:flex; flex-wrap:wrap; gap:8px 16px; margin-top:10px; }
.journal-score-item { font-size:13px; }
.journal-score-item span { font-weight:600; }
.journal-delete { background:none; border:none; color:var(--muted); font-size:18px; cursor:pointer; padding:2px 6px; border-radius:6px; transition:all 0.2s; }
.journal-delete:hover { color:var(--rose); background:rgba(200,60,100,0.12); }
/* Achievements */
.achievements { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
.achievement {
  display:flex; align-items:center; gap:6px;
  background:rgba(240,180,60,0.08); border:1px solid rgba(240,180,60,0.2);
  border-radius:12px; padding:8px 12px; font-size:12px;
}
.achievement.locked { opacity:0.35; filter:grayscale(0.8); }
.achievement-icon { font-size:20px; }
.achievement-name { font-weight:600; color:var(--gold); font-size:11px; }
.achievement-desc { font-size:10px; color:var(--muted); }

/* â•â• WORLD TAB â•â• */
.world-map-header { text-align:center; margin-bottom:18px; }
.world-map-header p { font-size:13px; color:var(--muted); margin-top:5px; }
.world-empty {
  text-align:center; padding:48px 20px; color:var(--muted);
  background:rgba(255,255,255,0.02); border:1px solid var(--border);
  border-radius:20px;
}
.hotspot-card {
  background:linear-gradient(135deg,rgba(255,255,255,0.042),rgba(255,255,255,0.014));
  border:1px solid var(--border); border-radius:18px;
  padding:15px 16px; margin-bottom:10px;
  display:flex; align-items:center; gap:14px;
  animation:slideUp 0.4s cubic-bezier(.22,1,.36,1) both;
  backdrop-filter:blur(16px); box-shadow:0 4px 20px rgba(0,0,0,0.28);
  transition:border-color 0.2s;
}
.hotspot-rank { font-family:'Cormorant Garamond',serif; font-size:27px; font-weight:600; color:var(--gold); min-width:36px; text-align:center; line-height:1; }
.hotspot-info  { flex:1; }
.hotspot-name  { font-size:15px; font-weight:600; margin-bottom:3px; }
.hotspot-desc  { font-size:12px; color:var(--muted); }
.hotspot-score { text-align:center; }
.hotspot-score-num   { font-size:26px; font-weight:700; font-family:'Cormorant Garamond',serif; line-height:1; }
.hotspot-score-label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.07em; }

/* â•â• INSTAGRAM SHARE CARD â•â• */
.share-card-section { margin-top:16px; }
.share-card {
  background:linear-gradient(135deg,rgba(255,185,80,0.1),rgba(200,60,100,0.08));
  border:1px solid rgba(240,180,60,0.25); border-radius:18px; padding:18px;
  text-align:center;
}
.share-card-title { font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:600; margin-bottom:4px; color:var(--gold2); }
.share-card-sub { font-size:12px; color:var(--muted); margin-bottom:14px; }
.share-card-preview {
  background:linear-gradient(160deg,#1a0830,#0d0420,#07040f);
  border-radius:14px; padding:20px; margin-bottom:14px;
  border:1px solid rgba(255,185,80,0.15);
}
.share-row { display:flex; gap:10px; justify-content:center; }
.share-btn-ig {
  flex:1; display:flex; align-items:center; justify-content:center; gap:8px;
  background:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);
  border:none; border-radius:12px; color:white; font-family:'Heebo',sans-serif;
  font-size:13px; font-weight:600; padding:11px 16px; cursor:pointer; transition:opacity 0.2s;
}
.share-btn-ig:hover { opacity:0.88; }
.share-btn-wa {
  flex:1; display:flex; align-items:center; justify-content:center; gap:8px;
  background:linear-gradient(135deg,#25D366,#128C7E);
  border:none; border-radius:12px; color:white; font-family:'Heebo',sans-serif;
  font-size:13px; font-weight:600; padding:11px 16px; cursor:pointer; transition:opacity 0.2s;
}
.share-btn-wa:hover { opacity:0.88; }

/* â•â• LOADING / ERROR â•â• */
.loading { text-align:center; padding:64px 20px; color:var(--muted); }
.loading-spinner { font-size:44px; display:block; margin-bottom:18px; animation:spin 2s linear infinite; }
@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
.error-box {
  background:rgba(200,60,100,0.09); border:1px solid rgba(200,60,100,0.28);
  border-radius:18px; padding:26px; text-align:center; margin:20px 0;
}
.error-box h3 { color:var(--rose); margin-bottom:9px; font-size:16px; }
.error-box p  { font-size:13px; color:var(--muted); line-height:1.65; }
.btn-primary  {
  display:block; width:100%; margin-top:16px;
  background:linear-gradient(135deg,var(--rose),var(--gold));
  border:none; border-radius:12px; color:white;
  font-family:'Heebo',sans-serif; font-size:15px; font-weight:600;
  padding:14px; cursor:pointer; transition:opacity 0.2s;
}
.btn-primary:hover { opacity:0.88; }

/* â•â• SHARE / FOOTER â•â• */
.share-section { margin-top:24px; text-align:center; }
.share-btn {
  display:inline-flex; align-items:center; gap:9px;
  background:linear-gradient(135deg,rgba(240,180,60,0.14),rgba(200,60,100,0.09));
  border:1px solid rgba(240,180,60,0.26); border-radius:14px;
  color:var(--gold2); font-family:'Heebo',sans-serif; font-size:14px; font-weight:500;
  padding:13px 30px; cursor:pointer; transition:all 0.25s; letter-spacing:0.03em;
}
.share-btn:hover { background:linear-gradient(135deg,rgba(240,180,60,0.22),rgba(200,60,100,0.15)); box-shadow:0 4px 22px rgba(240,165,50,0.18); transform:translateY(-1px); }
footer { text-align:center; margin-top:36px; font-size:11px; color:rgba(244,232,212,0.18); line-height:2.1; letter-spacing:0.05em; }

/* â•â• INSTALL BANNER â•â• */
.install-banner { display:none; align-items:center; gap:12px; background:rgba(240,180,60,0.08); border:1px solid rgba(240,180,60,0.2); border-radius:14px; padding:14px 16px; margin-bottom:16px; }
.install-banner.visible { display:flex; }
.install-banner p { flex:1; font-size:13px; color:var(--muted); line-height:1.5; }
.install-banner strong { color:var(--gold); display:block; font-size:14px; margin-bottom:2px; }
.install-dismiss { background:none; border:none; color:var(--muted); font-size:22px; cursor:pointer; padding:4px; transition:color 0.2s; }
.install-dismiss:hover { color:var(--text); }

/* "tomorrow alert" banner */
.tomorrow-alert {
  display:none; background:rgba(240,180,60,0.09); border:1px solid rgba(240,180,60,0.28);
  border-radius:14px; padding:12px 16px; margin-bottom:14px;
  font-size:13px; color:var(--gold2); align-items:center; gap:10px;
}
.tomorrow-alert.visible { display:flex; }
</style>
</head>
<body>

<!-- â”€â”€ Splash screen â”€â”€ -->
<div id="splash">
  <svg class="splash-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="sp-sky" cx="50%" cy="65%" r="75%">
        <stop offset="0%" stop-color="#2a0840"/><stop offset="55%" stop-color="#0e0428"/><stop offset="100%" stop-color="#06020e"/>
      </radialGradient>
      <radialGradient id="sp-sun" cx="50%" cy="40%" r="60%">
        <stop offset="0%" stop-color="#fff6b0"/><stop offset="35%" stop-color="#ffd040"/>
        <stop offset="75%" stop-color="#ff8c18"/><stop offset="100%" stop-color="#ff5500"/>
      </radialGradient>
      <radialGradient id="sp-hor" cx="50%" cy="0%" r="100%">
        <stop offset="0%" stop-color="#ff4010" stop-opacity="0.95"/>
        <stop offset="45%" stop-color="#ff7820" stop-opacity="0.65"/>
        <stop offset="100%" stop-color="#cc2050" stop-opacity="0.15"/>
      </radialGradient>
      <linearGradient id="sp-sea" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#162450"/><stop offset="100%" stop-color="#060c1a"/>
      </linearGradient>
      <radialGradient id="sp-glow" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#ffc030" stop-opacity="0.55"/>
        <stop offset="100%" stop-color="#ff5500" stop-opacity="0"/>
      </radialGradient>
      <filter id="sp-sf"><feGaussianBlur stdDeviation="1.5"/></filter>
      <clipPath id="sp-rc"><rect width="100" height="100" rx="22"/></clipPath>
    </defs>
    <g clip-path="url(#sp-rc)">
      <rect width="100" height="100" fill="url(#sp-sky)"/>
      <ellipse cx="50" cy="57" rx="58" ry="24" fill="url(#sp-hor)"/>
      <circle cx="50" cy="46" r="32" fill="url(#sp-glow)" filter="url(#sp-sf)"/>
      <g opacity="0.5" filter="url(#sp-sf)">
        <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.8" stroke-linecap="round"/>
        <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.8" stroke-linecap="round" transform="rotate(40 50 46)"/>
        <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.8" stroke-linecap="round" transform="rotate(-40 50 46)"/>
        <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.6" stroke-linecap="round" transform="rotate(80 50 46)"/>
        <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.6" stroke-linecap="round" transform="rotate(-80 50 46)"/>
      </g>
      <circle cx="50" cy="46" r="16" fill="url(#sp-sun)"/>
      <circle cx="50" cy="46" r="10" fill="#fff8c0" opacity="0.35"/>
      <rect x="2" y="61" width="96" height="2" fill="#ff8030" opacity="0.65"/>
      <rect x="2" y="63" width="96" height="35" fill="url(#sp-sea)"/>
      <ellipse cx="50" cy="72" rx="20" ry="4" fill="#ff7020" opacity="0.28"/>
      <rect x="2" y="90" width="96" height="8" fill="#06020e" opacity="0.75"/>
      <circle cx="17" cy="18" r="1.1" fill="white" opacity="0.90"/>
      <circle cx="72" cy="14" r="1.3" fill="white" opacity="0.85"/>
      <circle cx="60" cy="8" r="0.8" fill="#ffe0a0" opacity="0.80"/>
    </g>
  </svg>
  <div class="splash-title">×“××“×•××™×</div>
  <div class="splash-sub">×ª×—×–×™×ª ×¦×‘×¢×•× ×™×•×ª ×©×§×™×¢×•×ª ×•×–×¨×™×—×•×ª</div>
  <div class="splash-bar"><div class="splash-bar-fill"></div></div>
</div>

<div class="container">
  <header>
    <div class="logo-wrap">
      <div class="logo-glow"></div>
      <svg class="logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="skyG" cx="50%" cy="65%" r="75%">
            <stop offset="0%" stop-color="#2a0840"/><stop offset="55%" stop-color="#0e0428"/><stop offset="100%" stop-color="#06020e"/>
          </radialGradient>
          <radialGradient id="sunG" cx="50%" cy="40%" r="60%">
            <stop offset="0%" stop-color="#fff6b0"/><stop offset="35%" stop-color="#ffd040"/>
            <stop offset="75%" stop-color="#ff8c18"/><stop offset="100%" stop-color="#ff5500"/>
          </radialGradient>
          <radialGradient id="horizG" cx="50%" cy="0%" r="100%">
            <stop offset="0%" stop-color="#ff4010" stop-opacity="0.95"/>
            <stop offset="45%" stop-color="#ff7820" stop-opacity="0.65"/>
            <stop offset="100%" stop-color="#cc2050" stop-opacity="0.15"/>
          </radialGradient>
          <linearGradient id="seaG" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#162450"/><stop offset="100%" stop-color="#060c1a"/>
          </linearGradient>
          <radialGradient id="glowG" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#ffc030" stop-opacity="0.55"/>
            <stop offset="100%" stop-color="#ff5500" stop-opacity="0"/>
          </radialGradient>
          <filter id="sf"><feGaussianBlur stdDeviation="1.5"/></filter>
          <clipPath id="rc"><rect width="100" height="100" rx="22"/></clipPath>
        </defs>
        <g clip-path="url(#rc)">
          <rect width="100" height="100" fill="url(#skyG)"/>
          <ellipse cx="50" cy="57" rx="58" ry="24" fill="url(#horizG)"/>
          <circle cx="50" cy="46" r="32" fill="url(#glowG)" filter="url(#sf)"/>
          <g opacity="0.5" filter="url(#sf)">
            <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.8" stroke-linecap="round"/>
            <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.8" stroke-linecap="round" transform="rotate(40 50 46)"/>
            <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.8" stroke-linecap="round" transform="rotate(-40 50 46)"/>
            <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.6" stroke-linecap="round" transform="rotate(80 50 46)"/>
            <line x1="50" y1="14" x2="50" y2="8" stroke="#ffd040" stroke-width="1.6" stroke-linecap="round" transform="rotate(-80 50 46)"/>
          </g>
          <circle cx="50" cy="46" r="16" fill="url(#sunG)"/>
          <circle cx="50" cy="46" r="10" fill="#fff8c0" opacity="0.35"/>
          <rect x="2" y="61" width="96" height="2" fill="#ff8030" opacity="0.65"/>
          <rect x="2" y="63" width="96" height="35" fill="url(#seaG)"/>
          <ellipse cx="50" cy="72" rx="20" ry="4" fill="#ff7020" opacity="0.28"/>
          <ellipse cx="50" cy="80" rx="11" ry="2.2" fill="#ff5010" opacity="0.18"/>
          <rect x="2" y="90" width="96" height="8" fill="#06020e" opacity="0.75"/>
          <circle cx="17" cy="18" r="1.1" fill="white" opacity="0.90"/>
          <circle cx="32" cy="10" r="0.8" fill="white" opacity="0.70"/>
          <circle cx="72" cy="14" r="1.3" fill="white" opacity="0.85"/>
          <circle cx="85" cy="22" r="0.9" fill="white" opacity="0.65"/>
          <circle cx="60" cy="8" r="0.8" fill="#ffe0a0" opacity="0.80"/>
        </g>
      </svg>
    </div>
    <h1>×“××“×•××™×</h1>
    <p class="tagline">×ª×—×–×™×ª ×¦×‘×¢×•× ×™×•×ª ×©×§×™×¢×•×ª ×•×–×¨×™×—×•×ª</p>
    <div class="header-line"></div>
    <div id="streakBadge" style="display:none" class="streak-badge">ğŸ”¥ <span id="streakText"></span></div>
  </header>

  <div class="install-banner" id="installBanner">
    <div>
      <strong>ğŸ“² ×”×ª×§×Ÿ ×›××¤×œ×™×§×¦×™×”</strong>
      <p>×©×ª×£ â† "×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª"</p>
    </div>
    <button class="install-dismiss" onclick="document.getElementById('installBanner').classList.remove('visible')">Ã—</button>
  </div>

  <!-- Tomorrow alert banner -->
  <div class="tomorrow-alert" id="tomorrowAlert">
    <span>ğŸŒŸ</span>
    <span id="tomorrowAlertText"></span>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('forecast')">ğŸŒ… ×ª×—×–×™×ª</button>
    <button class="tab" onclick="switchTab('journal')">ğŸ““ ×™×•××Ÿ</button>
    <button class="tab" onclick="switchTab('world')">ğŸ—ºï¸ ×¢×•×œ×</button>
  </div>

  <!-- Location -->
  <div class="location-bar" onclick="loadData()">
    <span class="location-icon">ğŸ“</span>
    <div class="location-text">
      <strong id="locationName">×œ×—×¥ ×œ××™×ª×•×¨ ××™×§×•×</strong>
      <span id="locationCoords">GPS ××•×˜×•××˜×™</span>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="event.stopPropagation();loadData()">GPS</button>
  </div>

  <div class="city-search-row">
    <input class="city-input" id="cityInput" type="text" placeholder="×—×¤×© ×¢×™×¨..." onkeydown="if(event.key==='Enter')searchCity()"/>
    <button class="city-search-btn" onclick="searchCity()">ğŸ”</button>
    <button class="city-search-btn" onclick="addFavorite()" title="×”×•×¡×£ ××•×¢×“×£">â­</button>
  </div>
  <div class="favorites-strip" id="favStrip"></div>

  <!-- Notification banner -->
  <div class="notif-banner" id="notifBanner">
    <div class="notif-banner-title">ğŸ”” ×”×ª×¨××•×ª</div>
    <div class="notif-banner-row">
      <span class="notif-banner-label">ğŸŒ… ×©×§×™×¢×” â€” ×©×¢×” ×œ×¤× ×™</span>
      <button class="notif-toggle off" id="notifBtnSunset" onclick="toggleNotif('sunset')">×”×¤×¢×œ</button>
    </div>
    <div class="notif-banner-row">
      <span class="notif-banner-label">ğŸŒ„ ×–×¨×™×—×” â€” ×©×¢×” ×œ×¤× ×™</span>
      <button class="notif-toggle off" id="notifBtnSunrise" onclick="toggleNotif('sunrise')">×”×¤×¢×œ</button>
    </div>
    <div class="notif-threshold-row">
      <span class="notif-threshold-label">×¦×™×•×Ÿ ××™× ×™××•× ×œ×”×ª×¨××”:</span>
      <div class="threshold-btns">
        <button class="threshold-btn" onclick="setThreshold(6)">6+</button>
        <button class="threshold-btn" onclick="setThreshold(7)">7+</button>
        <button class="threshold-btn active" id="thr8" onclick="setThreshold(8)">8+</button>
        <button class="threshold-btn" onclick="setThreshold(9)">9+</button>
      </div>
    </div>
  </div>

  <!-- Tab content -->
  <div id="tab-forecast">
    <div id="content">
      <div class="loading">
        <span>ğŸŒ</span>
        <p style="margin-top:12px">×œ×—×¥ GPS ××• ×—×¤×© ×¢×™×¨</p>
      </div>
    </div>
    <div id="shareSection" style="display:none">
      <div class="share-card-section">
        <div class="share-card">
          <div class="share-card-title">ğŸ“¸ ×©×ª×£ ××ª ×”×ª×—×–×™×ª</div>
          <div class="share-card-sub">×©×œ×— ×œ×—×‘×¨×™× ×•×¢×“×›×Ÿ ×œ×”×™×›×Ÿ ×œ×¦××ª</div>
          <div class="share-card-preview" id="sharePreview"></div>
          <div class="share-row">
            <button class="share-btn-wa" onclick="shareWhatsapp()">ğŸ’¬ WhatsApp</button>
            <button class="share-btn-ig" onclick="shareApp()">ğŸ“¤ ×©×™×ª×•×£</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-journal" style="display:none">
    <div id="journalContent"></div>
  </div>

  <div id="tab-world" style="display:none">
    <div id="worldContent"></div>
  </div>

  <footer>
    × ×ª×•× ×™ ××–×’ ××•×•×™×¨: Open-Meteo â€¢ ×©××©: sunrise-sunset.org<br>
    ×“××“×•××™× Â© 2026
  </footer>
</div>

<script>
const DAYS_HE   = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
const MONTHS_HE = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

let userLat, userLon, currentWeatherData, currentSunData, currentCityName;
let notifSunset = false, notifSunrise = false;
let notifThreshold = 8;
let notifTimers = [];
let worldLoaded = false;

// â”€â”€ Storage helpers â”€â”€
function saveJournal(e) { try { localStorage.setItem('dmdum_journal', JSON.stringify(e)); } catch{} }
function loadJournal()  { try { return JSON.parse(localStorage.getItem('dmdum_journal') || '[]'); } catch{ return []; } }
function saveFavorites(f) { try { localStorage.setItem('dmdum_favs', JSON.stringify(f)); } catch{} }
function loadFavorites()  { try { return JSON.parse(localStorage.getItem('dmdum_favs') || '[]'); } catch{ return []; } }

// â”€â”€ Splash â”€â”€
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('splash').classList.add('hidden');
    setTimeout(() => document.getElementById('splash').remove(), 800);
  }, 1800);
});

// â”€â”€ Init â”€â”€
function init() {
  if (/Mobi|Android/i.test(navigator.userAgent) && !window.matchMedia('(display-mode: standalone)').matches) {
    document.getElementById('installBanner').classList.add('visible');
  }
  // Restore notif prefs
  if (localStorage.getItem('dmdum_notif_sunset') === '1') {
    notifSunset = true;
    document.getElementById('notifBtnSunset').textContent = '×¤×¢×™×œ âœ“';
    document.getElementById('notifBtnSunset').classList.remove('off');
  }
  if (localStorage.getItem('dmdum_notif_sunrise') === '1') {
    notifSunrise = true;
    document.getElementById('notifBtnSunrise').textContent = '×¤×¢×™×œ âœ“';
    document.getElementById('notifBtnSunrise').classList.remove('off');
  }
  // Restore threshold
  const savedThr = parseInt(localStorage.getItem('dmdum_threshold') || '8');
  notifThreshold = savedThr;
  document.querySelectorAll('.threshold-btn').forEach(b => {
    b.classList.toggle('active', b.textContent === savedThr+'+');
  });
  // Render favorites
  renderFavorites();
  // Show streak
  updateStreakBadge();
  // Try GPS
  loadData();
}

// â”€â”€ Streak â”€â”€
function updateStreakBadge() {
  const journal = loadJournal();
  if (!journal.length) return;
  // Count consecutive days with journal entries
  const today = new Date(); today.setHours(0,0,0,0);
  let streak = 0;
  for (let i=0; i<30; i++) {
    const d = new Date(today); d.setDate(today.getDate()-i);
    const ds = d.toISOString().split('T')[0];
    if (journal.some(e => e.id && e.id.startsWith(ds))) streak++;
    else if (i > 0) break;
  }
  if (streak >= 2) {
    document.getElementById('streakBadge').style.display = 'inline-flex';
    document.getElementById('streakText').textContent = streak + ' ×™××™× ×‘×¨×¦×£!';
  }
}

// â”€â”€ Tab switching â”€â”€
function switchTab(tab) {
  ['forecast','journal','world'].forEach(t => {
    document.getElementById('tab-'+t).style.display = t===tab ? 'block' : 'none';
  });
  document.querySelectorAll('.tab').forEach((el,i) => {
    el.classList.toggle('active', ['forecast','journal','world'][i]===tab);
  });
  if (tab==='journal') renderJournal();
  if (tab==='world' && !worldLoaded) { worldLoaded=true; renderWorld(); }
}

// â”€â”€ Favorites â”€â”€
function renderFavorites() {
  const favs = loadFavorites();
  const strip = document.getElementById('favStrip');
  if (!favs.length) { strip.innerHTML = ''; return; }
  strip.innerHTML = favs.map(f => `
    <div class="fav-chip" onclick="loadFav('${f.name}','${f.lat}','${f.lon}')">
      ğŸ“ ${f.name}
      <span class="fav-remove" onclick="event.stopPropagation();removeFavorite('${f.name}')">Ã—</span>
    </div>`).join('');
}

function addFavorite() {
  const city = document.getElementById('cityInput').value.trim() || currentCityName;
  if (!city || !userLat) { alert('×—×¤×© ×¢×™×¨ ×§×•×“×'); return; }
  const favs = loadFavorites();
  if (favs.find(f => f.name===city)) return;
  favs.unshift({ name: city, lat: userLat, lon: userLon });
  if (favs.length > 8) favs.pop();
  saveFavorites(favs);
  renderFavorites();
}

function removeFavorite(name) {
  saveFavorites(loadFavorites().filter(f => f.name !== name));
  renderFavorites();
}

async function loadFav(name, lat, lon) {
  userLat = parseFloat(lat); userLon = parseFloat(lon);
  currentCityName = name;
  document.getElementById('cityInput').value = name;
  document.getElementById('locationName').textContent = name;
  document.getElementById('locationCoords').textContent = `${userLat.toFixed(3)}Â°, ${userLon.toFixed(3)}Â°`;
  document.getElementById('content').innerHTML = `<div class="loading"><span class="loading-spinner">ğŸŒ¤ï¸</span><p>×˜×•×¢×Ÿ ${name}...</p></div>`;
  await fetchAndRender();
}

// â”€â”€ Threshold â”€â”€
function setThreshold(val) {
  notifThreshold = val;
  localStorage.setItem('dmdum_threshold', val);
  document.querySelectorAll('.threshold-btn').forEach(b => {
    b.classList.toggle('active', b.textContent === val+'+');
  });
}

// â”€â”€ GPS â”€â”€
async function loadData() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true; btn.textContent = '...';
  document.getElementById('content').innerHTML = `<div class="loading"><span class="loading-spinner">ğŸ›°ï¸</span><p>×××ª×¨ ××™×§×•×...</p></div>`;
  try {
    const pos = await getLocation();
    userLat = pos.coords.latitude;
    userLon = pos.coords.longitude;
    localStorage.removeItem('dmdum_last_city');
    await fetchAndRender();
  } catch(e) {
    document.getElementById('locationName').textContent = 'GPS ×œ× ×–××™×Ÿ';
    document.getElementById('locationCoords').textContent = '×—×¤×© ×¢×™×¨ ×™×“× ×™×ª ×œ××˜×”';
    const isPermissionDenied = e.code === 1;
    const extraMsg = isPermissionDenied
      ? '×œ××¤×©×¨ ××™×§×•×: ×”×’×“×¨×•×ª â† ××¤×œ×™×§×¦×™×•×ª â† ×“××“×•××™× â† ×”×¨×©××•×ª â† ××™×§×•×'
      : '×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××™×§×•× ××•×˜×•××˜×™×ª.';
    document.getElementById('content').innerHTML = `
      <div class="error-box" style="border-color:rgba(232,184,109,0.3);background:rgba(232,184,109,0.07)">
        <h3 style="color:var(--gold)">ğŸ“ ×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××™×§×•×</h3>
        <p>${extraMsg}<br><br>××• ×—×¤×© ×¢×™×¨ ×‘×ª×™×‘×ª ×”×—×™×¤×•×© ×œ××¢×œ×” ğŸ‘†</p>
        <button class="btn-primary" style="margin-top:12px" onclick="retryGPS()">ğŸ”„ × ×¡×” ×©×•×‘ GPS</button>
      </div>`;
    const lastCity = localStorage.getItem('dmdum_last_city');
    if (lastCity) {
      document.getElementById('cityInput').value = lastCity;
      setTimeout(() => searchCity(), 500);
    }
  }
  btn.disabled = false; btn.textContent = 'GPS';
}

function getLocation() {
  return new Promise((res,rej) => {
    if (!navigator.geolocation) rej(new Error('GPS ××™× ×• × ×ª××š'));
    navigator.geolocation.getCurrentPosition(res, (e) => {
      rej(Object.assign(new Error('×©×’×™××ª GPS'), {code: e.code}));
    }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 60000 });
  });
}

async function retryGPS() {
  if (navigator.permissions) {
    try { await navigator.permissions.query({name:'geolocation'}); } catch(e) {}
  }
  loadData();
}

// â”€â”€ City search â”€â”€
async function searchCity() {
  const query = document.getElementById('cityInput').value.trim();
  if (!query) return;
  document.getElementById('content').innerHTML = `<div class="loading"><span class="loading-spinner">ğŸ”</span><p>××—×¤×© "${query}"...</p></div>`;
  document.getElementById('shareSection').style.display = 'none';
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&accept-language=he`);
    const data = await res.json();
    if (!data.length) throw new Error(`×œ× × ××¦××” ×¢×™×¨ ×‘×©× "${query}"`);
    userLat = parseFloat(data[0].lat);
    userLon = parseFloat(data[0].lon);
    currentCityName = data[0].display_name.split(',')[0];
    localStorage.setItem('dmdum_last_city', query);
    document.getElementById('locationName').textContent = currentCityName;
    document.getElementById('locationCoords').textContent = `${userLat.toFixed(4)}Â°, ${userLon.toFixed(4)}Â°`;
    document.getElementById('content').innerHTML = `<div class="loading"><span class="loading-spinner">ğŸŒ¤ï¸</span><p>××•×¨×™×“ ×ª×—×–×™×ª...</p></div>`;
    await fetchAndRender();
  } catch(e) {
    document.getElementById('content').innerHTML = `<div class="error-box"><h3>×©×’×™××”</h3><p>${e.message}</p></div>`;
  }
}

// â”€â”€ Fetch + render â”€â”€
async function fetchAndRender() {
  const [weatherData, sunData, aqData, elevData] = await Promise.all([
    fetchWeather(userLat, userLon),
    fetchSunTimes(userLat, userLon),
    fetchAirQuality(userLat, userLon),
    fetchElevation(userLat, userLon)
  ]);
  currentWeatherData = weatherData;
  currentSunData = sunData;
  worldLoaded = false;
  renderCards(weatherData, sunData, aqData, elevData);
  updateDynamicBg(weatherData, sunData);
  checkTomorrowAlert(weatherData, sunData);
  document.getElementById('shareSection').style.display = 'block';
  updateSharePreview(weatherData, sunData, aqData, elevData);
  if (notifSunset || notifSunrise) scheduleNotifications(sunData, weatherData);
}

// â”€â”€ Dynamic background based on today's score â”€â”€
function updateDynamicBg(weatherData, sunData) {
  if (!weatherData?.hourly || !sunData?.[0]) return;
  const today = new Date().toISOString().split('T')[0];
  const ssHour = sunData[0]?.sunset ? new Date(sunData[0].sunset).getHours() : 19;
  const ssIdx = getHourlyIndex(weatherData, today, ssHour);
  const score = calcColorScore(
    weatherData.hourly.cloudcover[ssIdx]??40,
    weatherData.hourly.relativehumidity_2m[ssIdx]??55,
    weatherData.hourly.precipitation[ssIdx]??0,
    weatherData.hourly.windspeed_10m[ssIdx]??15
  );
  // Adjust CSS vars based on score
  const root = document.documentElement;
  if (score >= 8.5) {
    root.style.setProperty('--dyn1','rgba(255,80,30,0.22)');
    root.style.setProperty('--dyn2','rgba(255,150,30,0.18)');
    root.style.setProperty('--dyn3','rgba(200,60,100,0.12)');
  } else if (score >= 7) {
    root.style.setProperty('--dyn1','rgba(220,80,60,0.18)');
    root.style.setProperty('--dyn2','rgba(240,140,40,0.14)');
    root.style.setProperty('--dyn3','rgba(100,60,200,0.09)');
  } else if (score >= 5) {
    root.style.setProperty('--dyn1','rgba(180,80,100,0.14)');
    root.style.setProperty('--dyn2','rgba(200,130,50,0.10)');
    root.style.setProperty('--dyn3','rgba(60,100,200,0.08)');
  } else {
    root.style.setProperty('--dyn1','rgba(80,80,120,0.12)');
    root.style.setProperty('--dyn2','rgba(100,100,150,0.08)');
    root.style.setProperty('--dyn3','rgba(60,80,160,0.07)');
  }
}

// â”€â”€ Tomorrow alert â”€â”€
function checkTomorrowAlert(weatherData, sunData) {
  if (!weatherData?.hourly || !sunData?.[1]) return;
  const tmr = new Date(); tmr.setDate(tmr.getDate()+1);
  const tmrStr = tmr.toISOString().split('T')[0];
  const ssHour = sunData[1]?.sunset ? new Date(sunData[1].sunset).getHours() : 19;
  const ssIdx = getHourlyIndex(weatherData, tmrStr, ssHour);
  const score = calcColorScore(
    weatherData.hourly.cloudcover[ssIdx]??40,
    weatherData.hourly.relativehumidity_2m[ssIdx]??55,
    weatherData.hourly.precipitation[ssIdx]??0,
    weatherData.hourly.windspeed_10m[ssIdx]??15
  );
  const alert = document.getElementById('tomorrowAlert');
  if (score >= 8) {
    document.getElementById('tomorrowAlertText').textContent =
      `××—×¨ × ×¨××” ××“×”×™×! ×¦×™×•×Ÿ ${score}/10 â€” ×›×“××™ ×œ× ×œ×¤×¡×¤×¡ ğŸŒ…`;
    alert.classList.add('visible');
  } else {
    alert.classList.remove('visible');
  }
}

// â”€â”€ Share preview card â”€â”€
function updateSharePreview(weatherData, sunData, aqData, elevData) {
  const preview = document.getElementById('sharePreview');
  if (!preview || !sunData?.[0]) return;
  const today = new Date().toISOString().split('T')[0];
  const ssHour = sunData[0]?.sunset ? new Date(sunData[0].sunset).getHours() : 19;
  const ssIdx = weatherData?.hourly ? getHourlyIndex(weatherData, today, ssHour) : 0;
  const score = weatherData?.hourly ? calcColorScore(
    weatherData.hourly.cloudcover[ssIdx]??40,
    weatherData.hourly.relativehumidity_2m[ssIdx]??55,
    weatherData.hourly.precipitation[ssIdx]??0,
    weatherData.hourly.windspeed_10m[ssIdx]??15
  ) : 5;
  const q = getQualityInfo(score);
  const palette = getPalette(score, true);
  const sunset = formatLocalTime(sunData[0].sunset);
  const loc = document.getElementById('locationName').textContent;
  preview.innerHTML = `
    <div style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:#ffd46a;margin-bottom:4px">ğŸŒ… ${loc}</div>
    <div style="font-size:12px;color:rgba(244,232,212,0.5);margin-bottom:12px">×©×§×™×¢×”: ${sunset}</div>
    <div style="font-size:36px;font-weight:700;font-family:'Cormorant Garamond',serif" class="quality-${q.cls}">${score}<span style="font-size:16px;opacity:0.7">/10</span></div>
    <div style="font-size:14px;margin:6px 0 12px" class="quality-${q.cls}">${q.label}</div>
    <div style="display:flex;border-radius:8px;overflow:hidden;height:14px;gap:0">
      ${palette.map(c=>`<div style="flex:1;background:${c}"></div>`).join('')}
    </div>
    <div style="font-size:10px;color:rgba(244,232,212,0.25);margin-top:10px;letter-spacing:0.1em">DMDUMIIM APP</div>`;
}

// â”€â”€ Weather APIs â”€â”€
async function fetchWeather(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=cloudcover,relativehumidity_2m,precipitation,windspeed_10m,weathercode,temperature_2m&daily=weathercode,precipitation_sum,temperature_2m_max,temperature_2m_min,windspeed_10m_max,uv_index_max&timezone=auto&forecast_days=7`;
  try { const r = await fetch(url); if (!r.ok) throw new Error(); return await r.json(); } catch { return null; }
}

async function fetchAirQuality(lat, lon) {
  const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=dust,aerosol_optical_depth,pm10&timezone=auto&forecast_days=3`;
  try { const r = await fetch(url); if (!r.ok) throw new Error(); return await r.json(); } catch { return null; }
}

async function fetchElevation(lat, lon) {
  try {
    const lats = [lat, parseFloat((lat+0.1).toFixed(4)), parseFloat((lat-0.1).toFixed(4))];
    const lons = [lon, lon, lon];
    const url = `https://api.open-meteo.com/v1/elevation?latitude=${lats.join(',')}&longitude=${lons.join(',')}`;
    const r = await fetch(url); if (!r.ok) throw new Error();
    const d = await r.json();
    const myElev = d.elevation[0];
    const maxNearby = Math.max(...d.elevation.slice(1));
    return { myElev, obstruction: Math.max(0, maxNearby - myElev) };
  } catch { return { myElev:0, obstruction:0 }; }
}

async function fetchSunTimes(lat, lon) {
  const results = [];
  const today = new Date();
  for (let i=0; i<7; i++) {
    const d = new Date(today); d.setDate(today.getDate()+i);
    const dateStr = d.toISOString().split('T')[0];
    try {
      const r = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${dateStr}&formatted=0`);
      const data = await r.json();
      results.push(data.results);
    } catch { results.push(null); }
  }
  return results;
}

function getHourlyIndex(data, targetDateStr, targetHour) {
  const times = data.hourly.time;
  const target = `${targetDateStr}T${String(targetHour).padStart(2,'0')}:00`;
  let idx = times.findIndex(t => t===target);
  if (idx===-1) {
    const dateStart = times.findIndex(t => t.startsWith(targetDateStr));
    if (dateStart === -1) return 0;
    let best = dateStart, bestDiff = 24;
    for (let j=dateStart; j<Math.min(dateStart+24, times.length); j++) {
      const h = parseInt(times[j].split('T')[1]?.substring(0,2) ?? '0');
      const diff = Math.abs(h - targetHour);
      if (diff < bestDiff) { bestDiff=diff; best=j; }
    }
    idx = best;
  }
  return idx>=0 ? idx : 0;
}

// â”€â”€ Score calculation â”€â”€
function calcColorScore(cloudCover, humidity, rain, windspeed, dust=0, aod=0, horizonObstruction=0) {
  let score = 5;
  if (cloudCover < 5) score -= 1.5;
  else if (cloudCover < 10) score -= 0.5;
  else if (cloudCover <= 35) score += 3;
  else if (cloudCover <= 55) score += 1.5;
  else if (cloudCover <= 75) score -= 1;
  else score -= 3;
  if (rain > 5) score -= 2.5;
  else if (rain > 1) score -= 1.5;
  else if (rain > 0.2) score -= 0.5;
  else if (rain === 0 && cloudCover > 15 && cloudCover < 55) score += 0.5;
  if (humidity >= 35 && humidity <= 65) score += 0.5;
  else if (humidity > 85) score -= 0.5;
  if (windspeed > 40) score += 0.5;
  else if (windspeed < 5 && humidity > 70) score -= 0.3;
  if (dust > 0) {
    if (dust < 30) score += 0;
    else if (dust < 100) score += 0.8;
    else if (dust < 300) score += 1.5;
    else if (dust < 600) score += 0.5;
    else score -= 1.5;
  }
  if (aod > 0) {
    if (aod < 0.1) score += 0;
    else if (aod < 0.3) score += 0.5;
    else if (aod < 0.6) score += 1.0;
    else if (aod < 1.0) score += 0.3;
    else score -= 1.0;
  }
  if (horizonObstruction > 200) score -= 1.5;
  else if (horizonObstruction > 100) score -= 0.8;
  else if (horizonObstruction > 50) score -= 0.3;
  else if (horizonObstruction < 10) score += 0.2;
  return Math.min(10, Math.max(1, Math.round(score*10)/10));
}

function getDustLabel(dust) {
  if (!dust || dust < 30) return null;
  if (dust < 100) return {text:'ğŸŒ«ï¸ ××‘×§ ×§×œ â€” ×¦×¤×” ×œ×¦×‘×¢×™× ×—××™×', color:'#e8b86d'};
  if (dust < 300) return {text:'ğŸŒ«ï¸ ××‘×§ ××“×‘×¨×™ â€” ×©×§×™×¢×” ××”×××ª!', color:'#ff9a44'};
  if (dust < 600) return {text:'ğŸŒ«ï¸ ××‘×§ ×›×‘×“ â€” ×¦×‘×¢×™× ×¢×–×™× ××š ×¢×›×•×¨×™×', color:'#ff7b54'};
  return {text:'ğŸŒªï¸ ×¡×•×¤×ª ××‘×§ â€” ×¨××•×ª × ××•×›×”', color:'#d4607a'};
}

function getHorizonLabel(obstruction) {
  if (obstruction < 10) return null;
  if (obstruction < 50) return {text:'â›°ï¸ ×©×˜×— ×©×˜×•×— â€” ××•×¤×§ ×¤×ª×•×—', color:'#6ab0d4'};
  if (obstruction < 150) return {text:'â›°ï¸ ×’×‘×”×™× ××ª×•× ×™× ×‘×¨×§×¢', color:'#87ceeb'};
  return {text:'ğŸ”ï¸ ×”×¨×™× ×’×‘×•×”×™× ×¢×œ×•×œ×™× ×œ×—×¡×•×', color:'#9ca3af'};
}

function getQualityInfo(score) {
  if (score>=8.5) return {label:'ğŸ”¥ ××”××!',      cls:'spectacular', barCls:'bar-spectacular'};
  if (score>=7)   return {label:'ğŸŒŸ ×ª×•×¡×¡ ×•×¢×©×™×¨', cls:'vivid',       barCls:'bar-vivid'};
  if (score>=5.5) return {label:'âœ¨ ×™×¤×”',         cls:'nice',        barCls:'bar-nice'};
  if (score>=4)   return {label:'ğŸŒ¤ï¸ ×¢×“×™×Ÿ',        cls:'mild',        barCls:'bar-mild'};
  return             {label:'â˜ï¸ ×—×œ×©',            cls:'poor',        barCls:'bar-poor'};
}

function getPalette(score, isSunset) {
  if (score>=8.5) return isSunset ? ['#ff2d00','#ff6b2b','#ff9a44','#ffc96e','#ffe8a8'] : ['#ff4e6a','#ff8c69','#ffb347','#ffd700','#87ceeb'];
  if (score>=7)   return isSunset ? ['#e8390e','#f5712d','#f9a825','#fdd835','#fff3b0'] : ['#c0392b','#e67e22','#f39c12','#f1c40f','#aed6f1'];
  if (score>=5.5) return isSunset ? ['#c0392b','#e07030','#e8a040','#f5d080','#ffe0a0'] : ['#8e44ad','#d35400','#e67e22','#f39c12','#d4e6f1'];
  if (score>=4)   return ['#5b7a9d','#7ea8c4','#a8c4d8','#c8dce8','#e0eaf2'];
  return ['#4a5568','#6b7280','#9ca3af','#d1d5db','#e5e7eb'];
}

function formatLocalTime(utcStr) {
  if (!utcStr) return '--:--';
  try { return new Date(utcStr).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}); } catch { return '--:--'; }
}

function weatherCodeToEmoji(code) {
  if (code===0) return 'â˜€ï¸'; if (code<=2) return 'â›…'; if (code<=3) return 'â˜ï¸';
  if (code<=49) return 'ğŸŒ«ï¸'; if (code<=67) return 'ğŸŒ§ï¸'; if (code<=77) return 'â„ï¸';
  if (code<=82) return 'ğŸŒ¦ï¸'; return 'â›ˆï¸';
}
function weatherCodeToText(code) {
  if (code===0) return '×©××™×™× ×‘×”×™×¨×™×'; if (code<=2) return '××¢×•× ×Ÿ ×—×œ×§×™×ª'; if (code<=3) return '××¢×•× ×Ÿ';
  if (code<=49) return '×¢×¨×¤×œ'; if (code<=67) return '×’×©×'; if (code<=77) return '×©×œ×’';
  if (code<=82) return '×××˜×¨×™×'; return '×¡×•×¤×ª ×‘×¨×§×™×';
}

// â”€â”€ Golden window: 20 min before sunset â”€â”€
function getGoldenWindow(utcStr) {
  if (!utcStr) return '';
  try {
    const d = new Date(new Date(utcStr).getTime() - 20*60*1000);
    return d.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
  } catch { return ''; }
}

// â”€â”€ Toggle accordion â”€â”€
function toggleAccordion(id) {
  const detail = document.getElementById('detail-'+id);
  const arrow  = document.getElementById('arrow-'+id);
  if (!detail) return;
  detail.classList.toggle('open');
  arrow.classList.toggle('open');
}

// â”€â”€ Render forecast cards â”€â”€
function renderCards(weatherData, sunData, aqData=null, elevData=null) {
  const today = new Date();
  let html = '<div id="dayCards">';

  // â”€â”€ Weekly chart (7 days) â”€â”€
  if (weatherData?.hourly && sunData?.length >= 7) {
    let chartBars = '';
    for (let i=0; i<7; i++) {
      const d = new Date(today); d.setDate(today.getDate()+i);
      const ds = d.toISOString().split('T')[0];
      const dayShort = i===0 ? '×”×™×•×' : i===1 ? '××—×¨' : DAYS_HE[d.getDay()].substring(0,3);
      const ssHour = sunData[i]?.sunset ? new Date(sunData[i].sunset).getHours() : 19;
      const ssIdx = getHourlyIndex(weatherData, ds, ssHour);
      const score = calcColorScore(
        weatherData.hourly.cloudcover[ssIdx]??40,
        weatherData.hourly.relativehumidity_2m[ssIdx]??55,
        weatherData.hourly.precipitation[ssIdx]??0,
        weatherData.hourly.windspeed_10m[ssIdx]??15
      );
      const q = getQualityInfo(score);
      const colors = getPalette(score, true);
      const barColor = score >= 8 ? colors[2] : score >= 6 ? '#ffaa38' : '#5b7a9d';
      chartBars += `
        <div class="chart-bar-wrap">
          <div class="chart-bar-score quality-${q.cls}">${score}</div>
          <div class="chart-bar-outer">
            <div class="chart-bar-inner" style="height:${score*10}%;background:${barColor}"></div>
          </div>
          <div class="chart-bar-label">${dayShort}</div>
        </div>`;
    }
    html += `
      <div class="week-chart-section">
        <div class="week-chart-title">ğŸ“Š ×ª×—×–×™×ª ×©×‘×•×¢×™×ª</div>
        <div class="week-chart-sub">×¦×™×•×Ÿ ×©×§×™×¢×” ×œ×›×œ ×™×•× â€” 7 ×™××™× ×§×“×™××”</div>
        <div class="chart-bars">${chartBars}</div>
      </div>`;
  }

  // â”€â”€ 3 day cards â”€â”€
  for (let i=0; i<3; i++) {
    const d = new Date(today); d.setDate(today.getDate()+i);
    const dayName = i===0 ? '×”×™×•×' : i===1 ? '××—×¨' : `×™×•× ${DAYS_HE[d.getDay()]}`;
    const dateStrDisplay = `${d.getDate()} ×‘${MONTHS_HE[d.getMonth()]}`;
    const dateStr = d.toISOString().split('T')[0];
    const wCode = weatherData?.daily?.weathercode?.[i] ?? 1;

    const sunriseUTC = sunData[i]?.sunrise;
    const sunsetUTC  = sunData[i]?.sunset;
    const srHour = sunriseUTC ? new Date(sunriseUTC).getHours() : 6;
    const ssHour = sunsetUTC  ? new Date(sunsetUTC).getHours()  : 19;

    let srCloud=40, srHumidity=55, srRain=0, srWind=15;
    let ssCloud=40, ssHumidity=55, ssRain=0, ssWind=15;
    let tempMax='--', tempMin='--', uvIndex='--', wind='--', rain='--';

    if (weatherData?.hourly) {
      const srIdx = getHourlyIndex(weatherData, dateStr, srHour);
      const ssIdx = getHourlyIndex(weatherData, dateStr, ssHour);
      srCloud=weatherData.hourly.cloudcover[srIdx]??40;
      srHumidity=weatherData.hourly.relativehumidity_2m[srIdx]??55;
      srRain=weatherData.hourly.precipitation[srIdx]??0;
      srWind=weatherData.hourly.windspeed_10m[srIdx]??15;
      ssCloud=weatherData.hourly.cloudcover[ssIdx]??40;
      ssHumidity=weatherData.hourly.relativehumidity_2m[ssIdx]??55;
      ssRain=weatherData.hourly.precipitation[ssIdx]??0;
      ssWind=weatherData.hourly.windspeed_10m[ssIdx]??15;
    }
    if (weatherData?.daily) {
      tempMax = weatherData.daily.temperature_2m_max?.[i]?.toFixed(0) ?? '--';
      tempMin = weatherData.daily.temperature_2m_min?.[i]?.toFixed(0) ?? '--';
      uvIndex = weatherData.daily.uv_index_max?.[i]?.toFixed(0) ?? '--';
      wind    = weatherData.daily.windspeed_10m_max?.[i]?.toFixed(0) ?? '--';
      rain    = weatherData.daily.precipitation_sum?.[i]?.toFixed(1) ?? '--';
    }

    let srDust=0, srAod=0, ssDust=0, ssAod=0;
    if (aqData?.hourly) {
      const srAqIdx = aqData.hourly?.time ? getHourlyIndex(aqData, dateStr, srHour) : 0;
      const ssAqIdx = aqData.hourly?.time ? getHourlyIndex(aqData, dateStr, ssHour) : 0;
      srDust = aqData.hourly.dust?.[srAqIdx] ?? 0;
      srAod  = aqData.hourly.aerosol_optical_depth?.[srAqIdx] ?? 0;
      ssDust = aqData.hourly.dust?.[ssAqIdx] ?? 0;
      ssAod  = aqData.hourly.aerosol_optical_depth?.[ssAqIdx] ?? 0;
    }
    const horizonObs = elevData?.obstruction ?? 0;
    const myElev = elevData?.myElev ?? 0;

    const sunriseScore   = calcColorScore(srCloud, srHumidity, srRain, srWind, srDust, srAod, horizonObs);
    const ssScoreClamped = calcColorScore(ssCloud, ssHumidity, ssRain, ssWind, ssDust, ssAod, horizonObs);

    const dustLabel    = getDustLabel(Math.max(srDust, ssDust));
    const horizonLabel = getHorizonLabel(horizonObs);
    const srQ = getQualityInfo(sunriseScore);
    const ssQ = getQualityInfo(ssScoreClamped);
    const sunrise = sunData[i] ? formatLocalTime(sunData[i].sunrise) : '--:--';
    const sunset  = sunData[i] ? formatLocalTime(sunData[i].sunset)  : '--:--';
    const goldenSS = sunData[i] ? getGoldenWindow(sunData[i].sunset) : '';
    const goldenSR = sunData[i] ? getGoldenWindow(sunData[i].sunrise) : '';
    const srPaletteHtml = getPalette(sunriseScore,false).map(c=>`<div class="palette-swatch" style="background:${c}"></div>`).join('');
    const ssPaletteHtml = getPalette(ssScoreClamped,true).map(c=>`<div class="palette-swatch" style="background:${c}"></div>`).join('');

    let hourlyHtml = '';
    if (weatherData?.hourly) {
      const baseIdx = getHourlyIndex(weatherData, dateStr, 0);
      for (let h=0; h<8; h++) {
        const idx = baseIdx + h*3;
        if (idx >= weatherData.hourly.time.length) break;
        const time  = weatherData.hourly.time[idx].split('T')[1]?.substring(0,5) ?? '';
        const temp  = weatherData.hourly.temperature_2m?.[idx]?.toFixed(0) ?? '--';
        const cloud = weatherData.hourly.cloudcover?.[idx] ?? 0;
        const wc    = weatherData.hourly.weathercode?.[idx] ?? 0;
        hourlyHtml += `<div class="hourly-item"><div class="hourly-time">${time}</div><div class="hourly-icon">${weatherCodeToEmoji(wc)}</div><div class="hourly-temp">${temp}Â°</div><div class="hourly-cloud">â˜ï¸${cloud}%</div></div>`;
      }
    }

    const entryId = `${dateStr}-${i}`;
    const journal = loadJournal();
    const existing = journal.find(e => e.id===entryId);
    const cardStyle = i===0 ? 'border-color:rgba(240,165,50,0.22);box-shadow:0 6px 28px rgba(0,0,0,0.32),0 0 0 1px rgba(240,165,50,0.1),inset 0 1px 0 rgba(255,255,255,0.07)' : '';

    html += `
    <div class="day-card" style="animation-delay:${i*0.12}s;${cardStyle}">
      <div class="day-header">
        <div><div class="day-name">${dayName}</div><div class="day-date">${dateStrDisplay}</div></div>
        <div class="weather-summary">
          <span>${weatherCodeToEmoji(wCode)}</span><span>${weatherCodeToText(wCode)}</span>
        </div>
      </div>

      <div class="sun-events">
        <div class="sun-event">
          <div class="sun-event-title">ğŸŒ„ ×–×¨×™×—×”</div>
          <div class="sun-event-time">${sunrise}</div>
          ${goldenSR ? `<div class="golden-window">â­ ×–××Ÿ ×–×”×•×‘: ${goldenSR}</div>` : ''}
          <div class="score-label"><span>×¦×‘×¢×•× ×™×•×ª</span><span class="score-value quality-${srQ.cls}">${sunriseScore}/10</span></div>
          <div class="score-bar-track"><div class="score-bar-fill ${srQ.barCls}" style="width:${sunriseScore*10}%"></div></div>
          <div class="score-description quality-${srQ.cls}">${srQ.label}</div>
          <div class="color-palette">${srPaletteHtml}</div>
        </div>
        <div class="sun-event">
          <div class="sun-event-title">ğŸŒ‡ ×©×§×™×¢×”</div>
          <div class="sun-event-time">${sunset}</div>
          ${goldenSS ? `<div class="golden-window">â­ ×–××Ÿ ×–×”×•×‘: ${goldenSS}</div>` : ''}
          <div class="score-label"><span>×¦×‘×¢×•× ×™×•×ª</span><span class="score-value quality-${ssQ.cls}">${ssScoreClamped}/10</span></div>
          <div class="score-bar-track"><div class="score-bar-fill ${ssQ.barCls}" style="width:${ssScoreClamped*10}%"></div></div>
          <div class="score-description quality-${ssQ.cls}">${ssQ.label}</div>
          <div class="color-palette">${ssPaletteHtml}</div>
        </div>
      </div>

      <!-- Accordion weather -->
      <button class="accordion-btn" onclick="toggleAccordion('${entryId}')">
        <span>ğŸŒ¤ï¸ ×¤×¨×˜×™ ××–×’ ××•×•×™×¨</span>
        <span class="accordion-arrow" id="arrow-${entryId}">â–¼</span>
      </button>
      <div class="weather-detail" id="detail-${entryId}">
        <div class="weather-grid">
          <div class="weather-item"><span class="weather-item-icon">ğŸŒ¡ï¸</span><div class="weather-item-text"><strong>${tempMax}Â° / ${tempMin}Â°</strong>×˜××¤×¨×˜×•×¨×”</div></div>
          <div class="weather-item"><span class="weather-item-icon">ğŸ’§</span><div class="weather-item-text"><strong>${rain} ×"×</strong>××©×§×¢×™×</div></div>
          <div class="weather-item"><span class="weather-item-icon">ğŸ’¨</span><div class="weather-item-text"><strong>${wind} ×§×"×©</strong>×¨×•×— ××§×¡×™××œ×™×ª</div></div>
          <div class="weather-item"><span class="weather-item-icon">â˜€ï¸</span><div class="weather-item-text"><strong>UV ${uvIndex}</strong>×§×¨×™× ×”</div></div>
          <div class="weather-item"><span class="weather-item-icon">â˜ï¸</span><div class="weather-item-text"><strong>${srCloud}% / ${ssCloud}%</strong>×¢× ×Ÿ ×–×¨×™×—×”/×©×§×™×¢×”</div></div>
          <div class="weather-item"><span class="weather-item-icon">ğŸ’¦</span><div class="weather-item-text"><strong>${srHumidity}%</strong>×œ×—×•×ª</div></div>
        </div>
        ${hourlyHtml ? `<div class="hourly-strip">${hourlyHtml}</div>` : ''}
        ${dustLabel ? `<div style="margin-top:10px;padding:8px 12px;border-radius:10px;background:rgba(255,154,68,0.1);border:1px solid rgba(255,154,68,0.25);font-size:12px;color:${dustLabel.color};font-weight:600">${dustLabel.text}</div>` : ''}
        ${horizonLabel ? `<div style="margin-top:6px;padding:8px 12px;border-radius:10px;background:rgba(106,176,212,0.08);border:1px solid rgba(106,176,212,0.2);font-size:12px;color:${horizonLabel.color};font-weight:600">${horizonLabel.text}</div>` : ''}
        ${myElev > 0 ? `<div style="margin-top:6px;font-size:11px;color:var(--muted)">ğŸ“ ×’×•×‘×” ××™×§×•××š: ${myElev.toFixed(0)} ××˜×¨ ××¢×œ ×¤× ×™ ×”×™×</div>` : ''}
      </div>

      <!-- Rating -->
      <div class="rating-row">
        <div>
          <div class="rating-label">×“×¨×’ ××ª ×”×©×§×™×¢×” ×”×××™×ª×™×ª ğŸ‘‡</div>
          <div class="rating-saved" id="saved-${entryId}" style="display:${existing ? 'block' : 'none'}">${existing ? `âœ“ ×“×™×¨×’×ª ${existing.actualRating}â˜…` : ''}</div>
        </div>
        <div class="rating-stars" id="stars-${entryId}">
          ${[1,2,3,4,5].map(s=>`<span class="rating-star ${existing&&existing.actualRating>=s?'active':''}" onclick="rateEvent('${entryId}','${dateStrDisplay}',${s},${sunriseScore},${ssScoreClamped})">â­</span>`).join('')}
        </div>
      </div>
    </div>`;
  }

  html += '</div>';
  document.getElementById('content').innerHTML = html;
}

// â”€â”€ Rating / Journal â”€â”€
function rateEvent(entryId, dateDisplay, stars, srScore, ssScore) {
  const container = document.getElementById('stars-'+entryId);
  if (container) container.querySelectorAll('.rating-star').forEach((el,i) => el.classList.toggle('active', i<stars));
  const journal = loadJournal();
  const existing = journal.findIndex(e => e.id===entryId);
  const entry = {
    id: entryId, date: dateDisplay,
    location: document.getElementById('locationName').textContent,
    actualRating: stars, predictedSunrise: srScore, predictedSunset: ssScore, ts: Date.now()
  };
  if (existing>=0) journal[existing]=entry; else journal.unshift(entry);
  saveJournal(journal);
  const savedEl = document.getElementById('saved-'+entryId);
  if (savedEl) { savedEl.textContent=`âœ“ ×“×™×¨×’×ª ${stars}â˜…`; savedEl.style.display='block'; }
  updateStreakBadge();
  checkAchievements();
}

// â”€â”€ Achievements â”€â”€
const ACHIEVEMENTS_DEF = [
  {id:'first',  icon:'ğŸŒ…', name:'×¨××©×™×ª', desc:'×“×™×¨×•×’ ×¨××©×•×Ÿ', check: j => j.length >= 1},
  {id:'ten',    icon:'ğŸ“¸', name:'×¦×œ× ×©×§×™×¢×•×ª', desc:'10 ×“×™×¨×•×’×™×', check: j => j.length >= 10},
  {id:'streak3',icon:'ğŸ”¥', name:'3 ×‘×¨×¦×£', desc:'3 ×™××™× ×‘×¨×¦×£', check: j => calcStreakFromJournal(j) >= 3},
  {id:'streak7',icon:'â­', name:'×©×‘×•×¢ ×©×œ×', desc:'7 ×™××™× ×‘×¨×¦×£', check: j => calcStreakFromJournal(j) >= 7},
  {id:'perfect',icon:'ğŸ†', name:'××•×©×œ×', desc:'×“×™×¨×’×ª 5 ×›×•×›×‘×™×', check: j => j.some(e => e.actualRating === 5)},
  {id:'world',  icon:'ğŸŒ', name:'×’×œ×•×‘×˜×¨×•×˜×¨', desc:'×“×™×¨×•×’ ×‘-3 ×¢×¨×™×', check: j => new Set(j.map(e=>e.location)).size >= 3},
];

function calcStreakFromJournal(journal) {
  const today = new Date(); today.setHours(0,0,0,0);
  let streak = 0;
  for (let i=0; i<30; i++) {
    const d = new Date(today); d.setDate(today.getDate()-i);
    const ds = d.toISOString().split('T')[0];
    if (journal.some(e => e.id && e.id.startsWith(ds))) streak++;
    else if (i > 0) break;
  }
  return streak;
}

function checkAchievements() {
  const journal = loadJournal();
  const unlocked = JSON.parse(localStorage.getItem('dmdum_achievements') || '[]');
  ACHIEVEMENTS_DEF.forEach(a => {
    if (!unlocked.includes(a.id) && a.check(journal)) {
      unlocked.push(a.id);
      localStorage.setItem('dmdum_achievements', JSON.stringify(unlocked));
      // Subtle toast
      showToast(`${a.icon} ×”×™×©×’ ×—×“×©: ${a.name}!`);
    }
  });
}

function showToast(msg) {
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(240,180,60,0.18);border:1px solid rgba(240,180,60,0.4);color:#ffd46a;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:9999;backdrop-filter:blur(12px);animation:slideUp 0.3s ease';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// â”€â”€ Journal render â”€â”€
function renderJournal() {
  const journal = loadJournal();
  const el = document.getElementById('journalContent');
  if (!journal.length) {
    el.innerHTML = `<div class="journal-empty"><span class="je-icon">ğŸ““</span><p>×¢×“×™×™×Ÿ ××™×Ÿ ×¢×¨×›×™× ×‘×™×•××Ÿ.<br>×“×¨×’ ×©×§×™×¢×•×ª ××”×ª×—×–×™×ª!</p></div>`;
    return;
  }

  // Stats
  const avgRating = (journal.reduce((s,e) => s+e.actualRating, 0) / journal.length).toFixed(1);
  const streak = calcStreakFromJournal(journal);
  const bestEntry = journal.reduce((b,e) => e.predictedSunset > b.predictedSunset ? e : b, journal[0]);

  // Achievements
  const unlocked = JSON.parse(localStorage.getItem('dmdum_achievements') || '[]');
  const achievementsHtml = ACHIEVEMENTS_DEF.map(a => `
    <div class="achievement ${unlocked.includes(a.id)?'':'locked'}">
      <div class="achievement-icon">${a.icon}</div>
      <div><div class="achievement-name">${a.name}</div><div class="achievement-desc">${a.desc}</div></div>
    </div>`).join('');

  // Historical best
  const histBestScore = Math.max(...journal.map(e => e.predictedSunset));
  const histBest = journal.find(e => e.predictedSunset === histBestScore);

  el.innerHTML = `
    <div class="journal-stats">
      <div class="journal-stat">
        <div class="journal-stat-num">${journal.length}</div>
        <div class="journal-stat-label">×¡×”"×› ×“×™×¨×•×’×™×</div>
      </div>
      <div class="journal-stat">
        <div class="journal-stat-num">${avgRating}</div>
        <div class="journal-stat-label">×××•×¦×¢ ×›×•×›×‘×™×</div>
      </div>
      <div class="journal-stat">
        <div class="journal-stat-num">${streak > 0 ? streak+'ğŸ”¥' : 'â€”'}</div>
        <div class="journal-stat-label">×¨×¦×£ ×™××™×</div>
      </div>
    </div>
    ${histBest ? `<div style="background:rgba(240,180,60,0.07);border:1px solid rgba(240,180,60,0.2);border-radius:14px;padding:12px 16px;margin-bottom:14px;font-size:13px">ğŸ† <strong style="color:var(--gold)">×”×˜×•×‘×” ×”×©× ×”:</strong> ${histBest.date} ×‘${histBest.location} â€” ×¦×™×•×Ÿ ${histBestScore}/10</div>` : ''}
    <div style="font-size:12px;color:var(--muted);margin-bottom:10px;letter-spacing:0.1em;text-transform:uppercase">ğŸ… ×”×™×©×’×™×</div>
    <div class="achievements">${achievementsHtml}</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:10px;margin-top:6px;letter-spacing:0.1em;text-transform:uppercase">ğŸ“‹ ×¢×¨×›×™×</div>
    ${journal.map(e => `
    <div class="journal-entry">
      <div class="journal-entry-header">
        <div>
          <div class="journal-entry-date">${e.date}</div>
          <div class="journal-entry-loc">ğŸ“ ${e.location}</div>
        </div>
        <button class="journal-delete" onclick="deleteJournalEntry('${e.id}')">ğŸ—‘ï¸</button>
      </div>
      <div class="journal-scores">
        <div class="journal-score-item">×ª×—×–×™×ª ×–×¨×™×—×”: <span class="quality-${getQualityInfo(e.predictedSunrise).cls}">${e.predictedSunrise}/10</span></div>
        <div class="journal-score-item">×ª×—×–×™×ª ×©×§×™×¢×”: <span class="quality-${getQualityInfo(e.predictedSunset).cls}">${e.predictedSunset}/10</span></div>
        <div class="journal-score-item">×“×™×¨×•×’ ×××™×ª×™: <span style="color:var(--gold)">${'â­'.repeat(e.actualRating)}</span></div>
      </div>
    </div>`).join('')}`;
}

function deleteJournalEntry(id) {
  saveJournal(loadJournal().filter(e => e.id!==id));
  renderJournal();
  updateStreakBadge();
}

// â”€â”€ World map â”€â”€ only show score >= threshold (min 7)
const HOTSPOTS = [
  {name:'×¡× ×˜×•×¨×™× ×™, ×™×•×•×Ÿ',        desc:'×©×§×™×¢×•×ª ××¢×œ ×”×§×œ×“×¨×” ×”××’××™×ª',      lat:36.39,  lon:25.46,   emoji:'ğŸ‡¬ğŸ‡·'},
  {name:'×××•×•×™, ×”×•×•××™',          desc:'×”×¨ ×”××œ××§×œ×” ××¢×œ ×”×¢× × ×™×',           lat:20.80,  lon:-156.33, emoji:'ğŸŒº'},
  {name:'×× ×’×§×•×¨ ×•××˜, ×§××‘×•×“×™×”',  desc:'×–×¨×™×—×•×ª ××”×××•×ª ××¢×œ ×”××§×“×©×™×',      lat:13.41,  lon:103.86,  emoji:'ğŸ‡°ğŸ‡­'},
  {name:'×©×¨× ×-×©×™×™×—, ××¦×¨×™×',    desc:'×©×§×™×¢×•×ª ××“×‘×¨×™×•×ª ×¢×œ ×”×™× ×”××“×•×',    lat:27.91,  lon:34.33,   emoji:'ğŸ‡ªğŸ‡¬'},
  {name:'×§×™×™×¤ ×˜××•×Ÿ, ×“. ××¤×¨×™×§×”', desc:'×”×¨ ×©×•×œ×—×Ÿ ×•×©×§×™×¢×•×ª ××•×§×™×× ×•×¡',      lat:-33.92, lon:18.42,   emoji:'ğŸ‡¿ğŸ‡¦'},
  {name:'×“×•×‘××™, ××™×—×•×“ ×”×××™×¨×•×™×•×ª',desc:'×©×§×™×¢×•×ª ××“×‘×¨ ×¢×¨×‘×™×•×ª ×–×•×”×¨×•×ª',     lat:25.20,  lon:55.27,   emoji:'ğŸ‡¦ğŸ‡ª'},
  {name:'×¨×™×• ×“×” ×–×³× ×¨×•, ×‘×¨×–×™×œ',  desc:'×©××© ×©×•×§×¢×ª ××¢×œ ×”×¡×•×›×¨ ×”×œ×•×£',      lat:-22.90, lon:-43.17,  emoji:'ğŸ‡§ğŸ‡·'},
  {name:'×× ×˜×œ×•×£, ××¨×•×§×•',         desc:'×©×§×™×¢×•×ª ×•×¨×•×“×•×ª ××¢×œ ×”×¡×”×¨×”',        lat:31.00,  lon:-4.00,   emoji:'ğŸ‡²ğŸ‡¦'},
  {name:'×‘×œ×™, ××™× ×“×•× ×–×™×”',        desc:'×©×§×™×¢×•×ª ××§×“×© ×¢×œ ×”×™×',              lat:-8.34,  lon:115.09,  emoji:'ğŸ‡®ğŸ‡©'},
  {name:'×§×™×•×˜×•, ×™×¤×Ÿ',            desc:'×©×§×™×¢×•×ª ×¢×“×™× ×•×ª ××¢×œ ×’× ×™ ×”×‘××‘×•×§',   lat:35.01,  lon:135.76,  emoji:'ğŸ‡¯ğŸ‡µ'},
  {name:'××•× ×™×š, ×’×¨×× ×™×”',         desc:'××œ×¤×™× ×•×¨×•×“×™× ×‘×©×¢×ª ×”×©×§×™×¢×”',       lat:48.14,  lon:11.58,   emoji:'ğŸ‡©ğŸ‡ª'},
  {name:'××™×™×¡×œ× ×“',               desc:'×©××™×™× ×§×¡×•××™× ×•××•×¨×•×ª ×¦×¤×•× ×™×™×',     lat:64.13,  lon:-21.82,  emoji:'ğŸ‡®ğŸ‡¸'},
  {name:'×¤×˜×’×•× ×™×”, ××¨×’× ×˜×™× ×”',    desc:'×©××™×™× ×¤×ª×•×—×™× ×•×“×¨××˜×™×™×',           lat:-50.0,  lon:-73.0,   emoji:'ğŸ‡¦ğŸ‡·'},
  {name:'× ××™×‘×™×”, ××“×‘×¨',          desc:'×—×•×œ×•×ª ××“×•××™× ×‘×©×§×™×¢×”',             lat:-23.00, lon:17.00,   emoji:'ğŸ‡³ğŸ‡¦'},
  {name:'××œ×“×™×‘×™×™×',              desc:'×©×§×™×¢×•×ª ××¢×œ ×”××•×§×™×™× ×•×¡ ×”×”×•×“×™',      lat:4.17,   lon:73.51,   emoji:'ğŸ‡²ğŸ‡»'},
  {name:'×•××“×™ ×¨××, ×™×¨×“×Ÿ',        desc:'××“×‘×¨ ×›×××“×™× ×‘×©×¢×ª ×©×§×™×¢×”',         lat:29.57,  lon:35.42,   emoji:'ğŸ‡¯ğŸ‡´'},
  {name:'×¤×œ×•×¨× ×¥, ××™×˜×œ×™×”',        desc:'×©×§×™×¢×•×ª ××–×”×‘×•×ª ××¢×œ ×”××¨× ×•',         lat:43.77,  lon:11.25,   emoji:'ğŸ‡®ğŸ‡¹'},
  {name:'×§×•×œ×•×¨×“×•, ××¨×”"×‘',        desc:'×”×¨×™ ×”×¨×•×§×™ ×‘×¦×‘×¢×™ ×©×§×™×¢×”',          lat:39.55,  lon:-105.78, emoji:'ğŸ‡ºğŸ‡¸'},
  {name:'×“×¨×•× ×ª××™×œ× ×“',           desc:'×©×§×™×¢×•×ª ××¢×œ ×‘×™×™ ×§×¨××‘×™',            lat:8.08,   lon:98.91,   emoji:'ğŸ‡¹ğŸ‡­'},
  {name:'××•×¡×œ×•, × ×•×¨×•×•×’×™×”',       desc:'×¤×™×•×¨×“×™× ×‘×©××© ×—×¦×•×ª',               lat:59.91,  lon:10.75,   emoji:'ğŸ‡³ğŸ‡´'},
];

async function renderWorld() {
  const el = document.getElementById('worldContent');
  el.innerHTML = `
    <div class="world-map-header">
      <h2 style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600">ğŸ—ºï¸ ×™×¢×“×™ ×©×§×™×¢×•×ª ××•×‘×™×œ×™×</h2>
      <p>×¨×§ ×™×¢×“×™× ×¢× ×¦×‘×¢×•× ×™×•×ª ×’×‘×•×”×” â€” ×‘×–××Ÿ ×××ª</p>
    </div>
    <div class="loading"><span class="loading-spinner">ğŸŒ</span><p>××—×©×‘ ×ª×—×–×™×•×ª ×¢×•×œ××™×•×ª...</p></div>`;

  const results = await Promise.all(HOTSPOTS.map(async spot => {
    try {
      const [w, s] = await Promise.all([fetchWeather(spot.lat, spot.lon), fetchSunTimes(spot.lat, spot.lon)]);
      const sunsetUTC = s[0]?.sunset;
      const ssHour = sunsetUTC ? new Date(sunsetUTC).getHours() : 19;
      const today = new Date().toISOString().split('T')[0];
      let score = 5;
      if (w?.hourly) {
        const ssIdx = getHourlyIndex(w, today, ssHour);
        score = calcColorScore(w.hourly.cloudcover[ssIdx]??40, w.hourly.relativehumidity_2m[ssIdx]??55, w.hourly.precipitation[ssIdx]??0, w.hourly.windspeed_10m[ssIdx]??15);
      }
      const sunsetLocal = sunsetUTC ? new Date(sunsetUTC).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',timeZone:'UTC'}) + ' UTC' : '--:--';
      return {...spot, score, sunset: sunsetLocal};
    } catch { return {...spot, score:0, sunset:'--:--'}; }
  }));

  results.sort((a,b) => b.score-a.score);
  // Only show score >= 8
  const hotResults = results.filter(r => r.score >= 8);

  const header = `
    <div class="world-map-header">
      <h2 style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600">ğŸ—ºï¸ ×™×¢×“×™ ×©×§×™×¢×•×ª ××•×‘×™×œ×™×</h2>
      <p>${hotResults.length ? `ğŸ”¥ ${hotResults.length} ×™×¢×“×™× ×¢× ×¦×‘×¢×•× ×™×•×ª ×’×‘×•×”×” ×”×™×•×` : '×”×™×•× ××™×Ÿ ×™×¢×“×™× ×¢× ×¦×™×•×Ÿ 8+ â˜ï¸'}</p>
    </div>`;

  if (!hotResults.length) {
    el.innerHTML = header + `<div class="world-empty">
      <div style="font-size:48px;margin-bottom:12px">â˜ï¸</div>
      <p style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px">××™×Ÿ ×™×¢×“×™× ×‘×•×œ×˜×™× ×”×™×•×</p>
      <p>×›×œ ×”××§×•××•×ª ×‘×¢×•×œ× ××ª×—×ª ×œ×¦×™×•×Ÿ 8 â€” × ×¡×” ××—×¨!</p>
      <div style="margin-top:16px;font-size:12px;opacity:0.5">×”×¦×™×•×Ÿ ×”×’×‘×•×” ×‘×™×•×ª×¨ ×”×™×•×: ${results[0]?.score ?? 'â€”'} (${results[0]?.name ?? ''})</div>
    </div>`;
    return;
  }

  el.innerHTML = header + hotResults.map((spot,i) => {
    const q = getQualityInfo(spot.score);
    const isBest = i === 0;
    const borderStyle = isBest ? 'border-color:rgba(240,180,60,0.45)' : 'border-color:rgba(255,120,60,0.3)';
    return `<div class="hotspot-card" style="animation-delay:${i*0.08}s;${borderStyle}">
      <div class="hotspot-rank" style="${isBest?'color:var(--gold2)':''}">${isBest ? 'ğŸ†' : i+1}</div>
      <div class="hotspot-info">
        <div class="hotspot-name">${spot.emoji} ${spot.name} <span style="font-size:10px;background:rgba(255,120,60,0.2);color:#ff9a44;border-radius:4px;padding:1px 6px">×—×!</span></div>
        <div class="hotspot-desc">${spot.desc}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">ğŸŒ‡ ×©×§×™×¢×”: ${spot.sunset}</div>
      </div>
      <div class="hotspot-score">
        <div class="hotspot-score-num quality-${q.cls}">${spot.score}</div>
        <div class="hotspot-score-label">××ª×•×š 10</div>
        <div style="font-size:10px;margin-top:2px">${q.label}</div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ Notifications â”€â”€
async function toggleNotif(type) {
  if (!('Notification' in window)) { alert('×“×¤×“×¤×Ÿ ×–×” ××™× ×• ×ª×•××š ×‘×”×ª×¨××•×ª'); return; }
  const isSunset = type === 'sunset';
  const btnId = isSunset ? 'notifBtnSunset' : 'notifBtnSunrise';
  const storageKey = isSunset ? 'dmdum_notif_sunset' : 'dmdum_notif_sunrise';
  const isEnabled = isSunset ? notifSunset : notifSunrise;
  const btn = document.getElementById(btnId);
  if (!isEnabled) {
    const perm = await Notification.requestPermission();
    if (perm !== 'granted') { alert('× × ×œ××¤×©×¨ ×”×ª×¨××•×ª ×‘×”×’×“×¨×•×ª'); return; }
    if (isSunset) notifSunset = true; else notifSunrise = true;
    localStorage.setItem(storageKey, '1');
    btn.textContent = '×¤×¢×™×œ âœ“'; btn.classList.remove('off');
  } else {
    if (isSunset) notifSunset = false; else notifSunrise = false;
    localStorage.removeItem(storageKey);
    btn.textContent = '×”×¤×¢×œ'; btn.classList.add('off');
  }
  notifTimers.forEach(clearTimeout); notifTimers=[];
  if ((notifSunset || notifSunrise) && currentSunData && currentWeatherData)
    scheduleNotifications(currentSunData, currentWeatherData);
}

function scheduleNotifications(sunData, weatherData) {
  notifTimers.forEach(clearTimeout); notifTimers=[];
  const now = Date.now();
  sunData.forEach((day,i) => {
    if (!day) return;
    const dateStr = new Date(now+i*86400000).toISOString().split('T')[0];
    [{utc: day.sunrise, label:'×–×¨×™×—×”', isSunrise:true},{utc: day.sunset, label:'×©×§×™×¢×”', isSunrise:false}]
    .forEach(({utc, label, isSunrise}) => {
      if (!utc) return;
      if (isSunrise && !notifSunrise) return;
      if (!isSunrise && !notifSunset) return;
      const eventTime = new Date(utc).getTime();
      const notifTime = eventTime - 60*60*1000;
      if (notifTime <= now) return;
      const hour = new Date(utc).getHours();
      let score = 5;
      if (weatherData?.hourly) {
        const idx = getHourlyIndex(weatherData, dateStr, hour);
        score = calcColorScore(weatherData.hourly.cloudcover[idx]??40, weatherData.hourly.relativehumidity_2m[idx]??55, weatherData.hourly.precipitation[idx]??0, weatherData.hourly.windspeed_10m[idx]??15);
      }
      if (score >= notifThreshold) {
        const emoji = isSunrise ? 'ğŸŒ„' : 'ğŸŒ…';
        const t = setTimeout(() => {
          new Notification(`${emoji} ×“××“×•××™× â€” ${label} ××“×”×™××” ×‘×¢×•×“ ×©×¢×”!`, {
            body: `×¦×™×•×Ÿ: ${score}/10 | ${getQualityInfo(score).label} | ${formatLocalTime(utc)}`,
            icon: 'icon-192.png'
          });
        }, notifTime - now);
        notifTimers.push(t);
      }
    });
  });
}

// â”€â”€ Share â”€â”€
function shareWhatsapp() {
  const loc = document.getElementById('locationName').textContent;
  const score = document.querySelector('.hotspot-score-num, .score-value')?.textContent ?? '';
  const text = `ğŸŒ… ×“××“×•××™× â€” ×©×§×™×¢×ª ×”×¢×¨×‘ ×‘${loc} × ×¨××™×ª ××‘×˜×™×—×”!\n×”×•×¨×“: https://uri0411-jpg.github.io/sun-colors/`;
  window.open('https://wa.me/?text='+encodeURIComponent(text), '_blank');
}

async function shareApp() {
  const APK_LINK = 'https://uri0411-jpg.github.io/sun-colors/';
  const shareData = { title:'×“××“×•××™×', text:'ğŸŒ… ×“××“×•××™× â€” ×ª×—×–×™×ª ×¦×‘×¢×•× ×™×•×ª ×©×§×™×¢×•×ª ×•×–×¨×™×—×•×ª!', url: APK_LINK };
  try {
    if (navigator.share) await navigator.share(shareData);
    else { await navigator.clipboard.writeText(APK_LINK); showToast('×”×§×™×©×•×¨ ×”×•×¢×ª×§! ğŸŒ…'); }
  } catch {}
}

init();
</script>
</body>
</html>
